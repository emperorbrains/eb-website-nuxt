!function(){"use strict";function v(e){try{return JSON.parse(e)}catch(e){}return"object"==typeof e?e:{}}function f(e){try{return JSON.stringify(e)}catch(e){}return""}function l(e){return"function"==typeof e}function y(e,t){this.container=t,this.sdpConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!1},this.init(e)}y.prototype.init=function(e){this.chid=e.chatid,this.mid=e.id,this.type=e.type,this.localDescription="",this.remoteDescription="",this.localStream="",this.remoteStream="",this.localIceCandidates=[],this.remoteIceCandidates=[],this.iceRestart=e.iceRestart,this.isUpStream=e.isUpStream,this.connectionStatus="",this.rtcConnection="",this.isReconnecting=!1,this.streamData=null,this.remoteCandidatePushed=!1,this.mediaRequest=e.mediaRequest,this.reconnectInterval=null,this.statsObj=null,this.reconnectEndTimer=null,this.intRTCConn()},y.prototype.intRTCConn=function(){try{this.rtcConnection=new RTCPeerConnection(this.getCredentail()),this.localStream=this.container.MediaPermission.getStreamByType(this.type),this.isUpStream&&this.createOffer(),this.getRemoteStream(),this.rtcConnectionStatus()}catch(e){}},y.prototype.getCredentail=function(){var e=this.mid,t=this.container.dataHandler.get(e+"_credential");if(t.credential){var i=v(t.credential),n=i.servers.split(","),a=i.user_name,o=i.token,r=[];return n.forEach(function(e){r.push({urls:e,username:a,credential:o})}),{iceServers:r}}return null},y.prototype.createOffer=function(){var t=this;!this.iceRestart&&this.localStream&&this.addStream();var e=this.getSDPConstraints();this.iceRestart&&(e.iceRestart=!0),this.rtcConnection.createOffer(e).then(function(e){return t.offerSuccessCallBack(e)}).catch(function(e){return t.offerErrorCallBack(e)})},y.prototype.offerSuccessCallBack=function(e){this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e};this.container[this.type+"Impl"].sendOffer(this.contructResponse(t)),this.createIceCandidates()},y.prototype.offerErrorCallBack=function(){},y.prototype.createAnswer=function(){var t=this;this.rtcConnection.createAnswer(this.sdpConstraints).then(function(e){return t.answerSuccessCallBack(e)}).catch(function(e){return t.answerErrorCallBack(e)})},y.prototype.answerSuccessCallBack=function(e){this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e};this.container[this.type+"Impl"].sendAnswer(this.contructResponse(t))},y.prototype.addStream=function(){var t=this,i=this.rtcConnection,n=this.localStream;n&&n.getTracks().forEach(function(e){t.streamData=l(i.addTrack)?i.addTrack(e,n):i.addStream(n)})},y.prototype.createIceCandidates=function(){var n=this;this.localIceCandidates=[],this.rtcConnection.onicecandidate=function(e){n.localIceCandidates.push(e);var t,i={};e.candidate&&(i.label=e.candidate.sdpMLineIndex,i.type="candidate",i.id=e.candidate.sdpMid,i.candidate=e.candidate.candidate,t={candidates:n.container.detailsHandler.toJSON(i)},n.container[n.type+"Impl"].sendCandidate(n.contructResponse(t)))}},y.prototype.setRemoteDescription=function(e){var t=this;this.isUpStream||this.isReconnecting||this.iceRestart||this.addStream(),this.rtcConnection.setRemoteDescription(new RTCSessionDescription(v(e))).then(function(){t.isUpStream||(t.createAnswer(),t.createIceCandidates()),t.clearReconnectNWTimer()}),this.remoteDescription=e,this.remoteCandidatePushed||this.pushIceCandidate()},y.prototype.pushIceCandidate=function(){var i=this;this.remoteIceCandidates.forEach(function(e){var t=new RTCIceCandidate({sdpMid:e.id,sdpMLineIndex:e.label,candidate:e.candidate});i.rtcConnection.addIceCandidate(t)}),this.remoteCandidatePushed=!0},y.prototype.setIceCandidates=function(e){var t,i=v(e.candidates?e.candidates:e.msg.candidate);this.remoteDescription&&this.localDescription?(this.remoteIceCandidates&&0<this.remoteIceCandidates.length&&!this.remoteCandidatePushed&&this.pushIceCandidate(),t=new RTCIceCandidate({sdpMid:i.id,sdpMLineIndex:i.label,candidate:i.candidate}),this.rtcConnection.addIceCandidate(t)):(this.remoteIceCandidates&&0<this.remoteIceCandidates.length||(this.remoteIceCandidates=[]),this.remoteIceCandidates.push(i))},y.prototype.rtcConnectionStatus=function(){var i=this;this.rtcConnection.oniceconnectionstatechange=function(){var e,t=i.rtcConnection.iceConnectionState;"connected"==t?(e=i.type+"Impl",i.container[e].callConnected(i),i.container.commonImpl.clearNetworkTimer(i)):"failed"==t&&i.initReconnect()},this.rtcConnection.onconnectionstatechange=function(e){"failed"==i.rtcConnection.connectionState&&i.initReconnect()}},y.prototype.initReconnect=function(){this.isReconnecting=!0,this.iceRestart=!0,this.remoteIceCandidates=[],this.remoteDescription=null,this.remoteCandidatePushed=!1,this.container.commonImpl.checkNetwork(this.chid,this.mid)},y.prototype.getRemoteStream=function(){var t=this;this.rtcConnection.onaddstream=this.rtcConnection.ontrack=function(e){t.remoteStream=e,t.container[t.type+"Impl"].addRemoteStream(e,t)}},y.prototype.contructResponse=function(e){var t=this.mid,i=this.type,n=this.chid;return Object.assign({},{mid:t,type:i,chid:n},e)},y.prototype.closeConnection=function(){try{this.rtcConnection.close(),this.localStream&&this.closeTracksInStream(this.localStream)}catch(e){}},y.prototype.closeTracksInStream=function(e){try{e.getTracks().forEach(function(e){return e.stop()})}catch(e){}},y.prototype.getSDPConstraints=function(){var e=this.type,t=this.mid,i=this.chid,n=this.container,a=n.dataHandler,o=n.constants,r=a.get(i+"_call_status",!0)||{},c={offerToReceiveAudio:!0,offerToReceiveVideo:!0};return e==o.audio?c.offerToReceiveVideo=!1:e==o.screen_share&&(c.offerToReceiveVideo=r[t].mediarequest,c.offerToReceiveAudio=!1),c},y.prototype.clearReconnectNWTimer=function(){this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null,this.iceRestart=!1)};function e(e){((this.container=e).audioImpl=this).init(),this.audio="audio",this.timeout={},this.iconClicked={}}e.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},e.prototype.handleInvitation=function(e,t){var i=this;void 0===t&&(t=0);var n=this.container,a=n.constants,o=n.detailsHandler,r=n.commonImpl,c=n.uiHandler,s=e.chatid,l=e.id,d=(e.mode,e.type),u=e.mediaRequest,p=a.WAITING_TIME_SECS;if(o.canShowAudioCallInvitation(s))try{var h,m,g=function(){clearTimeout(i.timeout[l]),i.handleUIReject(d,s,l)},v={chid:s,media_id:l,rejectCbk:g,acceptCbk:function(){clearTimeout(i.timeout[l]),i.handleUIAccept(d,s,l,e.mediaInvitation)}};if(r.checkIncomingCallAllowed(e))return r.makeCallReject(d,l),!0;this.setCredential(e),e.mediaInvitation?(setTimeout(function(){c.handleAudioCallInvite(d,v)},500),r.setCallStatus(s,l,d,"incoming","ringing",u,"downstream"),m={type:"audiocall",duration:(h=r.getActiveTab())?"3":p,tone:h?"outgoingcall":"incomingcall",chatid:s,isEncrypted:!1},r.playMediaNotificationSound(m),r.showDesktopNotif({chatid:s}),this.timeout[l]=setTimeout(g,65e3)):(r.setCallStatus(s,l,d,"incoming","connecting",u,"downstream"),this.handleUIAccept(d,s,l,e.mediaInvitation)),r.updateIncomingRequestData(e);var f="siqMedia: media invitation  | chid :"+s+" | mediaid : "+l+" | curUserId : "+o.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,f),o.triggerIconCheck(s)}catch(e){}else t<3&&(0==t&&o.joinChat(s),setTimeout(function(){return i.handleInvitation(e,t++)},3e3))},e.prototype.callConnected=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=(e.isReconnecting,this.container),r=o.commonImpl,c=o.dataHandler,s=o.uiHandler,l=o.detailsHandler,d=r.getCallStatusByChid(i)[a].isdirectcall,u=(u=localStorage.getItem("siq_directcall"))&&v(u);clearTimeout(c.get(a+"_connecting_timer"));var p={chid:i,callEndCbk:d?function(){return t.handleUIApiCallEnd(i,n,a)}:function(){r.makeCallEnd(n,a),t.handleCallEnd({chatid:i,type:n,id:a})},muteCbk:function(){return t.toggleMute()},media_id:a,isDirectCall:d};s.updateCallInvitationState("audio",p,"connected"),r.updateCallStatus(i,a,"connected"),r.getEligibleMediaAction(i,n),l.triggerIconCheck(i),r.sendMediaStats({id:a},"call connected ");var h="siqMedia: Audio call connected  | chid :"+i+" | mediaid : "+a+" | curUserId : "+l.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,h);var m=c.get(i+"_peer");m&&m[a]&&m.reconnectEndTimer&&clearTimeout(m.reconnectEndTimer),u&&d&&(u.status="connected",localStorage.setItem("siq_directcall",f(u))),r.updateMediaStatsDetail({connectedTime:Date.now(),isreconnected:!1,mediaid:a});var g=r.getConnectedStatsDetail(a);r.makeCallConnected(g)},e.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=this.container,r=o.dataHandler,c=o.constants,s=o.commonImpl,l=o.uiHandler,d=o.detailsHandler,u=c.WAITING_TIME,p=i+"_peer",h=r.get(p)||{},m=s.getCallStatusByChid(i);e.isUpStream=!0,e.iceRestart=!1,h[n]=new y(e,this.container),clearTimeout(r.get(n+"_waiting_timer")),r.remove(n+"_waiting_timer"),r.set(p,h),s.updateCallStatus(i,n,"connecting"),r.set(n+"_connecting_timer",setTimeout(function(){s.makeCallEnd(a,n),t.clearData({type:a,chatid:i,id:n}),l.updateCallInvitationState("audio",{chid:i,media_id:n},"ended")},u));var g={chid:i,media_id:n,isDirectCall:m[n].isdirectcall,muteCbk:function(){return t.toggleMute()},rejectCbk:function(){return"upstream"==m[n].host?s.makeCallCancel(a,n):s.makeCallReject(a,n)}};l.updateCallInvitationState("audio",g,"connecting"),s.stopNotificationSound();try{var v={acceptedTime:Date.now(),callerType:0,lsid:d.getLsid(i),reconnectCount:0,type:a,mediaid:n};s.setMediaStatsDetail(v)}catch(e){}var f="siqMedia: call accept request received  | chid :"+i+" | mediaid : "+n+" | curUserId : "+d.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,f)},e.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.dataHandler,c=n.detailsHandler,s=a.getCallStatusByChid(t),l={chid:t,media_id:i,isDirectCall:s[i].isdirectcall};this.clearData(e),o.updateCallInvitationState("audio",l,"rejected"),clearTimeout(r.get(i+"_waiting_timer")),clearTimeout(r.get(i+"_connecting_timer")),delete s[i],a.removeCredential(i),c.handleCallRejected({type:"audio",chid:t});var d="siqMedia: call reject request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+c.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,d)},e.prototype.handleCandidates=function(e){var t=this.container.dataHandler,i=t.get(e.chatid+"_peer")[e.id];i||((i={})[e.id]=new y(e,this.container),t.set(e.chatid+"_peer",i),i=i[e.id]),i.setIceCandidates(e)},e.prototype.handleCallAnswer=function(e){var t=this.container.dataHandler.get(e.chatid+"_peer")[e.id],i=e.session;t.setRemoteDescription(i)},e.prototype.handleCallEnd=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=t.detailsHandler,o=i.getCallStatusByChid(e.chatid),r={chid:e.chatid,media_id:e.id,isDirectCall:o[e.id].isdirectcall};this.clearData(e),n.updateCallInvitationState("audio",r,"ended"),a.handleCallEnded({type:"audio",chid:e.chatid})},e.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=this.container.dataHandler,o=t+"_peer",r=a.get(o)||{};e.isUpStream=!1,e.iceRestart=!1;var c=r[i];r[i]||(r[i]=new y(e,this.container),a.set(t+"_peer",r),c=r[i]),c.setRemoteDescription(n)},e.prototype.handleCallCancel=function(e){try{var t=e.chatid,i=e.id,n=e.type,a=this.container,o=a.commonImpl,r=a.uiHandler,c=a.dataHandler,s=a.detailsHandler,l={chid:t,media_id:i,isDirectCall:o.getCallStatusByChid(t)[i].isdirectcall};o.removeCredential(i),r.updateCallInvitationState("audio",l,"cancelled"),clearTimeout(this.timeout[i]),clearTimeout(c.get(i+"_waiting_timer")),clearTimeout(c.get(i+"_connecting_timer"));var d="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+s.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,d),this.clearData(e),s.handleCallCancelled({type:n,chid:t})}catch(e){}},e.prototype.clearData=function(e){try{var t=this.container,i=t.detailsHandler,n=t.commonImpl,a=e.type,o=e.chatid||e.chid,r=e.id||e.mid,c="siqMedia: before clearing Audio call data  | chid :"+o+" | mediaid : "+r+" | curUserId : "+i.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c),this.closePeerConn(e),n.removeCredential(r),n.checkAVIcon(o),n.clearCallDetails(o,r),n.getActiveCallData()&&n.getActiveCallData()==o&&!n.getCallStatusByChid(o)&&(n.removeActiveCallData(),n.removeActiveTab(),this.clearMediaPermision(a)),n.removeIncomingRequestData(o),n.stopNotificationSound(),n.checkAndPlayNotification(),i.triggerIconCheck(o),n.clearConnectedStatsDetail(r)}catch(e){}},e.prototype.handleCallInvite=function(){},e.prototype.closePeerConn=function(e){var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=e.chatid||e.chid,o=e.id||e.mid,r=e.type;try{var c=i.get(a+"_peer");c[o].closeConnection(),delete c[o],this.clearMediaPermision(r),this.removeAudioPlayer()}catch(e){var s="siqMedia: error while clearing peer connection  | chid :"+a+" | mediaid : "+o+" | curUserId : "+n.getCurrentUserId()+" | error msg :"+e;this.callBackAction(this.implConstants.postDebugLog,s)}},e.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},e.prototype.startAudioCall=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.detailsHandler,o=i.uiHandler,r=i.MediaPermission,c=n.getActiveCallData();if(!this.iconClicked[e.chatid]){if(this.iconClicked[e.chatid]=!0,c){var s=n.getCallStatusByChid(c);for(var l in s)if("audio"==s[l].type)return void delete this.iconClicked[e.chatid]}try{var d=e.chatid,u=a.isembed;if("visitor"!=e.mode||(!!u||this.isAudioCallAllowed(e))){if(a.isAudioCallDisabled(d))return void delete this.iconClicked[e.chatid];var p=function(){clearTimeout(h)},h=setTimeout(function(){p=o.mediaPermissionUI()},3e3);r.getAudioStream(function(){p(),t.onMediaPermissionSuccess(e).call(t)},this.onUpStreamMediaPermissionFailure(function(){return p()},d))}else{var m="siqMedia: To start AUDIO call - permission checks failed | chid - "+d+" ";this.callBackAction(this.implConstants.postDebugLog,m),delete this.iconClicked[e.chatid]}}catch(e){}}},e.prototype.constructResponeObj=function(e){return Object.assign({},{type:"audio"},e)},e.prototype.onMediaPermissionSuccess=function(e){var t=this;try{var i=this.container,n=i.constants,a=i.commonImpl,o=i.ajaxHandler,r=n.WAITING_TIME_SECS;e.mode=e.mode?e.mode:"visitor";var c=this.constructResponeObj(e);a.setActiveTab(),c.mediainvitation=e.mediainvitation||!1,c.mediarequest=e.mediarequest||!1;var s=a.constructURL(null,null);a.setActiveCallData(e.chatid);var l={type:"audiocall",duration:r,tone:"outgoingcall",chatid:e.chatid,isEncrypted:!0};return a.playMediaNotificationSound(l),function(){o.post(s,c,t.onstarted.bind(t),t.startCallFailure.bind(t))}}catch(e){}},e.prototype.onUpStreamMediaPermissionFailure=function(n,a){var o=this,e=this.container,r=e.commonImpl,c=e.uiHandler;return function(e,t){n();var i=r.getFailureMessage(e);c.mediaPermissionUnlock(),c.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),delete o.iconClicked[a]}},e.prototype.onDownStreamMediaPermissionFailure=function(n){var e=this.container,a=e.commonImpl,o=e.uiHandler;return function(e,t){try{n.cbk(),o.mediaPermissionUnlock();var i=a.getFailureMessage(e);a.makeCallReject("audio",n.id),o.updateCallInvitationState("audio",{chid:n.chatid,media_id:n.id},"rejected"),o.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}})}catch(e){}}},e.prototype.isAudioCallAllowed=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=t.detailsHandler,o=t.MediaDetails,r=e.chatid;try{var c=a.getVisitorBrowser(r),s=a.getVisitorPage(r),l=!0,d="",u="";return i.getMediaDataByChidAndType({chatid:r,type:this.audio})?!1:(a.isChatMonitor(r)?(u="AUDIO - call Not Allowed because chat is in monitor | chid - "+r+" | visitorId - ",d=a.I18N("av.info.chatinvite"),l=!1):"Google Chrome"!==c&&"Mozilla Firefox"!==c&&"Apple Safari"!==c&&"Opera"!==c?(d=a.I18N("av.info.visitorbrowsernotsupported"),u="AUDIO call - Failed visitor browser not supported | chid - "+r+" | visitorId -  | browser-"+c,l=!1):o.checkBrowserSupported()?"https"!=s.substring(0,5)?(d=a.I18N("av.info.insecuredwebsite"),u="AUDIO call-Failed Visitor not in secure connection | chid - "+r+" |  visitorId - ",l=!1):a.isGroupConversation(r)?(d=a.I18N("av.info.chatinvite"),u="AUDIO call-Failed Visitor not in secure connection | chid - "+r+" |  visitorId - ",l=!1):a.isAttenderBot(r)?(u="AUDIO call-Failed bot attender | chid - "+r+" |  visitorId - ",l=!1):a.isFaceBookIntegration(r)&&(d=a.I18N("av.info.facebookpagenotsupported"),u="AUDIO call-Failed Visitor is in Facebook page | chid - "+r+" |  visitorId - ",l=!1):(u="AUDIO call-Failed agent browser not supported| chid - "+r,l=!1),l||(n.showDialog({desc:d,ok:{text:"common.ok",callback:function(){return null}}}),this.callBackAction(this.implConstants.postDebugLog,u)),l)}catch(e){var p="failed in isAudioCallAllowed method | chid - "+r;this.callBackAction(this.implConstants.postDebugLog,p)}},e.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},e.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},e.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},e.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},e.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},e.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},e.prototype.addRemoteStream=function(e,t){var i=this.container,n=i.detailsHandler,a=i.commonImpl;try{var o="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+n.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o);var r="",c=e.stream;t.type==this.audio&&(r=this.addAudioPlayer()),e.streams&&(c=e.streams[0]);try{r.srcObject=c}catch(e){r.src=window.URL.createObjectURL(c)}a.checkAndUpdateUIForApi()}catch(e){var s="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+n.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,s)}},e.prototype.addAudioPlayer=function(){try{var e="siqMedia: creating audio player stream  | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,e);var t=document.querySelector("#remoteaudio");if(null!=t&&null!=t&&0!=t.length)return t[0];var i=document.createElement("audio");return i.id="remoteaudio",i.autoplay=!0,document.querySelector("body").appendChild(i),i}catch(e){}},e.prototype.removeAudioPlayer=function(){var e=document.querySelector("#remoteaudio");e.parentNode.removeChild(e)},e.prototype.startCallFailure=function(){this.iconClicked={},callBackAction()},e.prototype.startcall=function(e,t,i){var n={},a=this.container,o=a.ajaxHandler,r=a.commonImpl;n.type=e,n.chatid=t,n.mode=i||"visitor";var c=r.constructURL(null,null);r.setActiveCallData(t),o.post(c,n,this.onstarted,this.startCallFailure)},e.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,c=a.getCallStatusByChid(t);o.updateCallInvitationState("audio",{chid:t,media_id:i,isDirectCall:c[i].isdirectcall},"rejected"),a.makeCallReject(e,i),this.clearData({type:e,chatid:t,id:i}),r.handleCallRejected({type:e,chid:t});var s=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+r.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,s)},e.prototype.handleUIEnd=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler;try{var c={chid:t,media_id:i,isDirectCall:call_status[id].isdirectcall};a.makeCallEnd(e,i),o.updateCallInvitationState("audio",c,"rejected"),r.triggerIconCheck(t),this.clearData({type:e,chatid:t,id:i}),this.container.detailsHandler.handleCallEnded({type:e,chid:t})}catch(e){}},e.prototype.endOngoingCall=function(e,t,i){try{var n=this.container,a=n.dataHandler,o=n.uiHandler,r=n.commonImpl,c=a.get(e+"_peer");if(c)for(var s in c){var l=c[s];o.updateCallInvitationState(l.type,{chid:e,media_id:l.mid},"ended"),r.makeCallEnd(l.type,l.mid,i),this.clearData(l),delete c[s]}else{r.makeCallEnd("audio",t,i),this.clearData({type:"audio",chatid:e,id:t})}r.removeActiveCallData(e)}catch(e){}},e.prototype.__handleUIAccept=function(i,n,a){var o=this,e=this.container,r=e.commonImpl,c=e.detailsHandler,s=e.uiHandler,t=e.MediaPermission,l=e.dataHandler,d=e.constants,u=r.getActiveCallData(),p=r.getCallStatusByChid(u),h=r.getCallStatusByChid(n);if(c.focusChatWindow(n),u&&u!=n){for(var m in p)!function(e){var t=p[e],i=t.type+"Impl",n=t.callStatus;"connected"==n?o.container[i].endOngoingCall(u,e,function(){return t.isdirectcall&&c.endSession(u)}):"ringing"!=n&&"connecting"!=n||(("upstream"==p[e].host?o.container[i].handleUICancel.bind(o):o.container[i].handleUIReject.bind(o))(t.type,u,t.id),r.removeActiveCallData())}(m)}var g=function(){clearTimeout(v)},v=setTimeout(function(){g=s.mediaPermissionUI()},3e3);t.getAudioStream(function(){g(),r.updateCallStatus(n,a,"connecting"),r.setActiveCallData(n),r.makeCallAccept("audio",a);var e={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==h[a].host?o.handleUICancel(i,n,a):o.handleUIReject(i,n,a)}};s.updateCallInvitationState("audio",e,"connecting");var t=d.WAITING_TIME;l.set(a+"_connecting_timer",setTimeout(function(){r.makeCallEnd(i,a),o.clearData({type:i,chatid:n,id:a}),s.updateCallInvitationState("audio",{chid:n,media_id:a},"ended")},t))},this.onDownStreamMediaPermissionFailure({chatid:n,id:a,cbk:g})),r.removeIncomingRequestData(n),r.setActiveTab(),r.stopNotificationSound()},e.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container,r=o.detailsHandler,c=o.uiHandler,s=o.commonImpl,l=s.getActiveCallData();l&&l!=t?c.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n);var d={acceptedTime:Date.now(),callerType:1,lsid:r.getLsid(t),reconnectCount:0,type:e,mediaid:i};s.setMediaStatsDetail(d)},e.prototype.handleUICancel=function(e,t,i){var n=this.container,a=n.detailsHandler,o=n.uiHandler,r=n.commonImpl;o.updateCallInvitationState(e,{chid:t,media_id:i},"cancelled"),r.makeCallCancel(e,i),this.clearData({type:e,chatid:t,id:i}),a.handleCallCancelled({type:e,chid:t});var c=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+a.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)},e.prototype.toggleMute=function(){this.container.MediaPermission.toggleMute()},e.prototype.startVisitorAudioCall=function(e){var t={chatid:e,mode:"visitor",mediarequest:!0,mediainvitation:!0,type:"audio"};this.startAudioCall(t)},e.prototype.handleCallMissed=function(e){var t=this.container,i=t.detailsHandler,n=t.uiHandler;try{var a=e.chatid,o=e.id;this.clearData(e);var r={chid:a,media_id:o};clearTimeout(this.timeout[o]),n.updateCallInvitationState("audio",r,"missed"),i.handleCallMissed({type:"audio",chid:a})}catch(e){var c=" call missed  | chid :"+chatid+" | mediaid : "+id+" | curUserId : "+i.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)}},e.prototype.acceptAudioCallForDsk=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=i.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.__handleUIAccept(this.type,e,a,!0),n.clearAudioCallInvite(this.audio,a)},e.prototype.rejectAudioCallForDsk=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=i.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.handleUIReject(this.type,e,a),n.clearAudioCallInvite(this.audio,a)},e.prototype.hasIncommingCall=function(e){var t=this.container.commonImpl.getCallStatusByChid(e);for(var i in t){var n=t[i];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1};function t(e){e.videoImpl=this}t.prototype.handleInvitation=function(){},t.prototype.handleCallAccept=function(){},t.prototype.handleCallReject=function(){},t.prototype.handleCandidates=function(){},t.prototype.handleCallAnswer=function(){},t.prototype.handleCallEnd=function(){},t.prototype.handleCallOffer=function(){},t.prototype.handleCallCancel=function(){},t.prototype.handleCallCancel=function(){},t.prototype.handleCallInvite=function(){};function i(e){(e.screenShareImpl=this).container=e,this.timeout={},this.init()}i.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},i.prototype.handleInvitation=function(e){function t(e){void 0===e&&(e=!0),clearTimeout(n.timeout[o]),e?n.handleUIAccept(r,a,o):n.handleUIReject(r,a,o)}function i(){return t(!1)}var n=this,a=e.chatid,o=e.id,r=e.type,c=this.container,s=c.commonImpl,l=c.uiHandler,d=c.MediaPermission,u={chid:a,media_id:o,rejectCbk:i,acceptCbk:t};if(s.checkIncomingCallAllowed(e))return s.makeCallReject(r,o),!0;this.setCredential(e),e.mediaInvitation?(l.handleAudioCallInvite("screen_share",u),s.setCallStatus(a,o,r,"incoming","ringing",e.mediaRequest,"downstream"),this.timeout[o]=setTimeout(i,65e3)):(s.setCallStatus(a,o,r,"incoming","connecting",e.mediaRequest,"downstream"),e.mediaRequest?d.getScreenShareStream(function(){s.makeCallAccept("screen_share",o),d.screenEndFromBrowserUI(function(){return n.handleUIEnd({type:r,id:o,chatid:a})})},this.onMediaPermissionFailure(a,o)):(s.setActiveCallData(a),s.makeCallAccept("screen_share",o)),s.setActiveTab())},i.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=this.container,r=o.dataHandler,c=o.commonImpl,s=o.constants,l=o.uiHandler,d=i+"_peer",u=r.get(d)||{};e.isUpStream=!0,e.iceRestart=!1,u[n]=new y(e,this.container),r.set(d,u),clearTimeout(r.get(n+"_waiting_timer")),r.remove(n+"_waiting_timer");var p={chid:i,media_id:n,muteCbk:function(){},rejectCbk:function(){c.makeCallCancel(a,n),l.updateCallInvitationState(a,{chid:i,media_id:n},"cancelled"),t.clearData(e)}};c.updateCallStatus(i,n,"connecting"),l.updateCallInvitationState(s.screen_share,p,s.connecting)},i.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id;e.type;this.container.uiHandler.updateCallInvitationState("screen_share",{chid:t,media_id:i},"rejected"),this.clearData(e)},i.prototype.handleCandidates=function(e){var t=this.container.dataHandler,i=t.get(e.chatid+"_peer")[e.id];i||((i={})[e.id]=new y(e,this.container),t.set(e.chatid+"_peer",i),i=i[e.id]),i.setIceCandidates(e)},i.prototype.handleCallAnswer=function(e){var t=this.container.dataHandler.get(e.chatid+"_peer")[e.id],i=e.session;t.setRemoteDescription(i)},i.prototype.handleCallEnd=function(e){var t=e.type,i=e.id,n=e.chatid,a=this.container,o=a.uiHandler,r=a.detailsHandler;o.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),r.clearPlayer(),this.clearData(e)},i.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=this.container.dataHandler,o=t+"_peer",r=a.get(o)||{};e.isUpStream=!1,e.iceRestart=!1;var c=r[i];r[i]||(r[i]=new y(e,this.container),a.set(t+"_peer",r),c=r[i]),c.setRemoteDescription(n)},i.prototype.handleCallCancel=function(e){var t=e.chatid,i=e.id,n=(e.type,this.container),a=n.commonImpl,o=n.uiHandler,r={chid:t,media_id:i};a.removeCredential(i),o.updateCallInvitationState("screen_share",r,"cancelled"),this.clearData(e),clearTimeout(this.timeout[i]);var c="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)},i.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.uiHandler,o=n.commonImpl,r=n.detailsHandler;a.updateCallInvitationState(e,{chid:t,mid:i},"rejected"),o.makeCallReject(e,i),this.clearData({type:e,chid:t,mid:i});var c=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+r.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)},i.prototype.__handleUIAccept=function(i,n,a){var o=this,e=this.container,r=e.commonImpl,c=e.uiHandler,s=e.MediaPermission,t=r.getActiveCallData(),l=r.getCallStatusByChid(t),d=r.getCallStatusByChid(n);if(t&&t!=n)for(var u in l){var p=l[u].callStatus,h=l[u].id;"connected"==p?this.endOngoingCall(t):"ringing"!=p&&"connecting"!=p||(("upstream"==l[u].host?r.makeCallCancel.bind(r):r.makeCallReject.bind(r))(i,h),r.removeActiveCallData())}r.getCallStatusByChid(n)[a].mediarequest?s.getScreenShareStream(function(){var e,t=r.getCallStatusByChid(n);t&&t[a]?(r.updateCallStatus(n,a,"connecting"),r.setActiveCallData(n),r.makeCallAccept(i,a),e={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==d[a].host?r.makeCallCancel(i,a):r.makeCallReject(i,a)}},c.updateCallInvitationState(i,e,"connecting"),s.screenEndFromBrowserUI(function(){return o.handleUIEnd({type:i,id:a,chatid:n})})):s.closeStreamByType(i)},this.onMediaPermissionFailure(n,a)):r.makeCallAccept("screen_share",id),r.removeIncomingRequestData(n),r.setActiveTab()},i.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container,r=o.uiHandler,c=o.commonImpl.getActiveCallData();c&&c!=t?r.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n)},i.prototype.startScreenShare=function(e){try{var t,i=this.container,n=i.detailsHandler,a=i.MediaPermission,o=i.commonImpl,r=e.mediarequest,c=e.chatid,s=!0,l=r?"view_screen":"share_screen";if("visitor"==e.mode){if(n.checkIsSSOnGoing(c,l))return;s=this.isScreenShareAllowed(e,l)}s?r?this.initRequest(this.onMediaPermissionSuccess(e)):a.getScreenShareStream(this.onMediaPermissionSuccess(e),this.onMediaPermissionFailure(c,e.id,!0)):(t="To start Siq Screen Share  - permission checks failed | chid - "+c+" ",this.callBackAction(this.implConstants.postDebugLog,t)),o.setActiveTab()}catch(e){}},i.prototype.initRequest=function(e){e()},i.prototype.onMediaPermissionSuccess=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.ajaxHandler;e.mode=e.mode?e.mode:"visitor";var o=this.constructResponeObj(e),r=n.constructURL(null,null);return n.setActiveCallData(e.chatid),function(){a.post(r,o,t.onstarted.bind(t),t.startCallFailure.bind(t))}},i.prototype.onMediaPermissionFailure=function(o,r,c){var s=this;return void 0===c&&(c=!1),function(e,t){try{var i=s.container,n=i.commonImpl,a=i.uiHandler;c||(n.makeCallReject("screen_share",r),a.updateCallInvitationState("screen_share",{chid:o,media_id:r},"rejected"))}catch(e){}}},i.prototype.constructResponeObj=function(e){return Object.assign({},{type:"screen_share"},e)},i.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},i.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},i.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},i.prototype.onstarted=function(e){var t=this,i=v(v(e.msg||e.data.msg).media),n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.dataHandler,c=n.MediaPermission,s=n.detailsHandler,l=i.chatid,d=i.id,u=i.type,p=i.mediaRequest,h={};h.chid=l,h.id=d,h.type=u,h.callType="outgoing",h.callStatus="ringing",h.mediarequest=p,h.host="upstream";r.set(d+"_waiting_timer",setTimeout(function(){a.makeCallMissed(u,d),t.clearData(i),o.updateCallInvitationState(u,{chid:l,media_id:d},"missed")},6e4));var m=r.get(l+"_call_status",!0)||{};m[d]=h,r.set(l+"_call_status",m,!0);var g={chid:l,media_id:d,cancelCbk:function(){return t.handleUICancel(u,l,d)},muteCbk:function(){}};o.showScreenShareMaking(u,g),p||c.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:u,id:d,chatid:l})}),s.triggerIconCheck(l)},i.prototype.startCallFailure=function(){},i.prototype.addRemoteStream=function(e,t){var i=this;try{var n=t.type,a=t.mid,o=t.chid,r=e.stream;e.streams&&(r=e.streams[0]),this.container.uiHandler.playScreenShareStream({stream:r,chid:o,mid:a,endCbk:function(){return i.handleUIEnd({type:n,id:a,chatid:o})}})}catch(e){}},i.prototype.clearData=function(e){try{var t=this.container.commonImpl,i=e.chatid||e.chid,n=e.id||e.mid;this.closePeerConn(e),t.removeCredential(n),t.checkAVIcon(i),t.clearCallDetails(i,n),t.getActiveCallData()&&t.getActiveCallData()==i&&!t.getCallStatusByChid(i)&&t.removeActiveCallData(),t.removeIncomingRequestData(i),t.stopNotificationSound(),t.checkAndPlayNotification(),t.getCallStatusByChid(i)||t.removeActiveTab()}catch(e){}},i.prototype.closePeerConn=function(e){var t=e.chatid,i=e.type,n=e.id;try{var a=this.container.dataHandler.get(t+"_peer");if(!a)return void this.clearMediaPermision(i);a[n].closeConnection(),delete a[n],this.clearMediaPermision(i)}catch(e){}},i.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},i.prototype.handleUIEnd=function(e){var t=e.type,i=e.id,n=e.chatid,a=this.container,o=a.uiHandler,r=a.detailsHandler;a.commonImpl.makeCallEnd(t,i),o.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),r.clearPlayer(),this.clearData(e)},i.prototype.callConnected=function(e){this.screenShareConnectedUI(e)},i.prototype.screenShareConnectedUI=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=e.isUpStream,r=this.container,c=r.commonImpl,s=r.uiHandler,l=c.getCallStatusByChid(i)[a].mediarequest,d=c.getEligibleMediaAction(e.chid,n),u={chid:i,media_id:a,eligibleOption:d,isViewing:o&&l||!o&&!l,muteCbk:function(){return function(){}},callEndCbk:function(){return t.handleUIEnd({chatid:e.chid,type:n,id:a})}};c.updateCallStatus(i,a,"connected"),s.updateCallInvitationState("screen_share",u,"connected")},i.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},i.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},i.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},i.prototype.handleUICancel=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r={chid:t,media_id:i,type:e};a.makeCallCancel(e,i),this.clearData({type:e,chatid:t,id:i}),o.updateCallInvitationState("screen_share",r,"cancelled")},i.prototype.swapScreenShare=function(e,t){void 0===t&&(t={});var i=e.chatid,n=e.id,a=this.container,o=a.screenShareImpl,r=a.commonImpl,c=this.getScreenShareType(i,n);o.handleUIEnd({type:"screen_share",id:n,chatid:i}),r.removeActiveCallData();var s={chatid:i,mode:"visitor",type:"screen_share",mediainvitation:!0,mediarequest:!0};c&&(s.mediarequest=!1,s.mediainvitation=!1);var l=Object.assign({},s,t);o.startScreenShare(l)},i.prototype.getScreenShareType=function(e,t){var i=this.container.commonImpl.getCallStatusByChid(e),n=i&&i[t];if(!i||!n)return-1;var a=n.mediarequest,o="upstream"==n.host;return o&&a?1:o&&!a||!o&&a?0:o||a?void 0:1},i.prototype.endOngoingCall=function(e,t){var i=this.container,n=i.dataHandler,a=i.uiHandler,o=i.commonImpl,r=n.get(e+"_peer");if(r)for(var c in r){var s=r[c];a.updateCallInvitationState(s.type,{chid:e,media_id:s.mid},"ended"),o.makeCallEnd(s.type,s.mid),this.clearData(s),delete r[c]}else{o.makeCallEnd("screen_share",t),this.clearData(peer)}o.removeActiveCallData(e)},i.prototype.isScreenShareSupported=function(){};function n(e){((this.container=e).commonImpl=this).reloadCheck=!1}n.prototype.setCredential=function(e){var t=e.id,i=e.type,n={mid:t,credential:e.credentials,chid:e.chatid,type:i};this.container.dataHandler.set(t+"_credential",n)},n.prototype.removeCredential=function(e){this.container.dataHandler.remove(e+"_credential")},n.prototype.constructURL=function(e,t){var i="media";return e&&(i+="/"+t+"/"+e),i},n.prototype.sendOffer=function(e){e.chid;var t=e.description,i=e.mid,n=(e.type,this.container),a=n.detailsHandler,o=n.ajaxHandler,r=this.constructURL("offer",i),c={};c.session=a.toJSON(t),o.post(r,c,null,null)},n.prototype.sendAnswer=function(e){e.chid;var t=e.description,i=e.mid,n=(e.type,this.container),a=n.detailsHandler,o=n.ajaxHandler,r=this.constructURL("answer",i),c={};c.session=a.toJSON(t),o.post(r,c,null,null)},n.prototype.sendCandidate=function(e){var t=e.candidates,i=(e.chid,e.mid),n=(e.type,this.constructURL("candidates",i)),a={};a.candidates=t,this.container.ajaxHandler.post(n,a,null,null)},n.prototype.setActiveCallData=function(e){this.container.dataHandler.set("active_call",e,!0)},n.prototype.getActiveCallData=function(){return this.container.dataHandler.get("active_call",!0)},n.prototype.removeActiveCallData=function(){this.container.dataHandler.remove("active_call",!0)},n.prototype.setCallStatus=function(e,t,i,n,a,o,r,c){void 0===c&&(c=!1);var s={chid:e,id:t,type:i,callType:n,callStatus:a,mediarequest:o,host:r,isdirectcall:c},l=this.getCallStatusByChid(e)||{};l[t]=s,this.container.dataHandler.set(e+"_call_status",l,!0)},n.prototype.getCallStatusByChid=function(e){return this.container.dataHandler.get(e+"_call_status",!0)},n.prototype.getAcitveMediaTypes=function(){var e=this.container.dataHandler.get("active_call",!0),t=this.getCallStatusByChid(e);return t?Object.values(t).map(function(e){return e.type}):[]},n.prototype.updateCallStatus=function(e,t,i){var n=this.container.dataHandler,a=n.get(e+"_call_status",!0);a&&a[t]&&(a[t].callStatus=i),n.set(e+"_call_status",a,!0)},n.prototype.checkAVIcon=function(e){var t=this.container,i=t.dataHandler,n=t.uiHandler;i.get("active_call",!0)==e&&n.enableOutingCallUI()},n.prototype.checkNetwork=function(t,i,e){var n=this;void 0===e&&(e=!1);var a=this.container,o=a.dataHandler,r=a.uiHandler,c=o.get(t+"_peer")[i],s=c.type;c.reconnectInterval=setTimeout(function(){var e=document.createElement("IMG");e.src=_MEDIASERVERURL+"/images/spacer.gif?nocache="+(new Date).getTime(),e.onload=function(){c.iceRestart=!0,c.isUpStream&&c.createOffer(),n.updateAcceptedTimeForMediaStats(Date.now(),i)},e.onerror=function(){return n.checkNetwork(t,i,!0)}},5e3),c.reconnectEndTimer||(c.reconnectEndTimer=setTimeout(function(){n.container[s+"Impl"].endOngoingCall(t),clearTimeout(c.reconnectInterval),c.reconnectEndTimer=null},3e4)),e||r.updateCallInvitationState(s,{chid:t,media_id:i},"reconnecting")},n.prototype.clearNetworkTimer=function(e){clearTimeout(e.reconnectEndTimer),clearTimeout(e.reconnectInterval)},n.prototype.clearCallDetails=function(e,t){var i=this.container.dataHandler,n=i.get(e+"_call_status",!0);delete n[t],0<Object.keys(n).length?i.set(e+"_call_status",n,!0):i.remove(e+"_call_status",!0),i.remove(t+"_credential")},n.prototype.updateCommonData=function(){},n.prototype.getCommonData=function(){},n.prototype.makeCallMissed=function(e,t,i){this.makeCallHelper("miss",e,t,i)},n.prototype.makeCallAccept=function(e,t,i){this.makeCallHelper("accept",e,t,i)},n.prototype.makeCallCancel=function(e,t,i){this.makeCallHelper("cancel",e,t,i)},n.prototype.makeCallEnd=function(e,t,i){this.makeCallHelper("end",e,t,i)},n.prototype.makeCallReject=function(e,t,i){this.makeCallHelper("reject",e,t,i)},n.prototype.makeCallConnected=function(e){var t=e.callerType,i=e.latency,n=e.lsid,a=e.mediaid,o=e.reconcount,r=e.wmsid,c=this.constructURL("connected",a),s={latency:i,reconcount:o,callerType:t,lsid:n};r&&(s.wmsid=r),this.container.ajaxHandler.post(c,s,null,null)},n.prototype.makeCallHelper=function(e,t,i,n){var a=this.container,o=a.commonImpl,r=a.ajaxHandler,c=o.constructURL(e,i);r.post(c,{},n)},n.prototype.updateIncomingRequestData=function(e){var t={},i=e.chatid,n=e.type,a=e.id,o=this.container.dataHandler,r=o.get("media_inv")||[];t[i]={type:n,id:a},r.push(t),o.set("media_inv",r,!0)},n.prototype.removeIncomingRequestData=function(e){var t=this.container.dataHandler,i=t.get("media_inv",!0);for(var n in i){var a=i[n];Object.keys(a)[0]==e&&i.splice(n,1)}i&&(0==i.length?this.deleteIncomingRequestKey():t.set("media_inv",i,!0))},n.prototype.getIncomingRequest=function(){return this.container.dataHandler.get("media_inv",!0)},n.prototype.deleteIncomingRequestKey=function(){this.container.dataHandler.remove("media_inv",!0)},n.prototype.getMediaDataByChidAndType=function(e){var t=e.chatid,i=e.type,n=this.getCallStatusByChid(t);for(var a in n){var o=n[a];if(o.type==i)return o}return null},n.prototype.endCallByChid=function(s,l){var d=this;try{var u=this.getCallStatusByChid(s),e=this.container,p=e.detailsHandler,h=e.uiHandler,m=e.commonImpl,g=e.dataHandler;for(var t in u)!function(e){var t=u[e],i=t.id,n=t.type,a=t.callStatus,o=t.isdirectcall,r=d.container[n+"Impl"],c={chid:s,media_id:i,type:n};"connected"==a?(r.endOngoingCall(s,i,l||function(){return o&&p.endSession(s)}),h.updateCallInvitationState(n,c,"ended")):"connected"!=a&&"incoming"==t.callType?(o||m.makeCallReject(n,i,l),h.updateCallInvitationState(n,c,"rejected"),o&&r.handleUIApiReject(n,s,i)):"connected"!=a&&"outgoing"==t.callType&&(clearTimeout(g.get(i+"_waiting_timer")),m.makeCallCancel(n,i,l),h.updateCallInvitationState(n,c,"cancelled")),c.id=i,r.clearData(c)}(t)}catch(e){}},n.prototype.checkOnGoingCall=function(){try{this.checkAndClearDataOnRefresh()}catch(e){}},n.prototype.checkAndClearDataOnRefresh=function(){var t=this;Object.keys(localStorage).forEach(function(e){return e.match(/SiqMedia_/g)&&t.container.dataHandler.remove(e.replace("SiqMedia_",""),!0)})},n.prototype.setActiveTab=function(){this.container.dataHandler.set("media_active",!0)},n.prototype.getActiveTab=function(){return this.container.dataHandler.get("media_active")||!1},n.prototype.removeActiveTab=function(){this.container.dataHandler.remove("media_active")},n.prototype.currentUserBrowserSupportSS=function(){var e=this.container.MediaDetails,t=e.getPlatform();return!!/linux|Microsoft Windows|Mac OS|MacIntel|Win32|Win64/i.test(t)&&e.checkBrowserSupported()},n.prototype.checkIncomingCallAllowed=function(e){var t=e.chatid,i=(e.id,e.type);if(this.getMediaDataByChidAndType({chatid:t,type:i}))for(var n=this.container.dataHandler.get(t+"_peer"),a=n&&Object.keys(n).length||0,o=0;o<a;o++){return"connected"!=n[Object.keys(n)[o]].connectionStatus?(this.endCallByChid(t),!1):!0}return!1},n.prototype.setMediaStatsDetail=function(e){var t=e.acceptedTime,i=e.type,n=e.mediaid,a={acceptedTime:t,type:i,mediaid:n,reconnectCount:e.reconnectCount,lsid:e.lsid,callerType:e.callerType};this.container.dataHandler.set(n+"_connectionstats",a)},n.prototype.updateMediaStatsDetail=function(e){var t=e.connectedTime,i=e.isreconnected,n=e.mediaid,a=this.container.dataHandler,o=a.get(n+"_connectionstats");o.connectedTime=t,o.reconnectCount=i?o.reconnectCount+1:o.reconnectCount,a.set(n+"_connectionstats",o)},n.prototype.updateAcceptedTimeForMediaStats=function(e,t){var i=this.container.dataHandler,n=i.get(t+"_connectionstats");n.acceptedTime=e,i.set(t+"_connectionstats",n)},n.prototype.getConnectedStatsDetail=function(e){var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=i.get(e+"_connectionstats"),o={latency:a.connectedTime-a.acceptedTime,reconcount:a.reconnectCount,callerType:a.callerType,lsid:a.lsid,mediaid:e};return n.isEmbed()&&(o.wmsid=n.getVisitorWMSID()),o},n.prototype.clearConnectedStatsDetail=function(e){this.container.dataHandler.remove(e+"_connectionstats")};var a=function(e){function t(){e.apply(this,arguments),this.isDirectCallAllowed=!1}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.audioIconStatus=function(e,t,i){void 0===i&&(i=1);var n=this.container,a=n.detailsHandler,o=n.commonImpl.getMediaDataByChidAndType({chatid:e,type:"audio"})||!1,r={not_group_chat:!a.isGroupConversation(e),not_bot:!a.isAttenderBot(e),ongoing_chat:a.isChatExist(e),audiocall_enabled:a.isAudioCallEnabled(),current_plan_allowed:a.isPlanAllowed(),is_secure:a.isSecureConnection(),is_proactive_chat:!a.isProactiveChat(e),live_chat_window:a.isliveChatWindow(),isFacebookIntegration:!a.isFaceBookIntegration()},c={ongoing_call_current_chat:o,incoming_call_notification:a.hasIncomingCall(e)},s={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed","is_secure","is_proactive_chat","live_chat_window","isFacebookIntegration"]}[i].map(function(e){return r[e]}).reduce(function(e,t){return e&&t},!0),l={1:["ongoing_call_current_chat","incoming_call_notification"]}[i].map(function(e){return c[e]}).reduce(function(e,t){return e||t},!1);t(e,s?l?"disable":"show":"hide")},t.prototype.onstarted=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.MediaPermission,o=i.detailsHandler,r=i.uiHandler,c=i.dataHandler;if(e.data.error&&"5001"==e.data.error.code)return n.removeActiveTab(),n.removeActiveCallData(),a.closeAllStream(),o.hideAudioCall(),o.stopNotifSound(),!0;var s=v(v(e.data.msg).media),l=s.chatid,d=s.id,u=s.type,p=s.mediaRequest;this.iconClicked={};c.set(d+"_waiting_timer",setTimeout(function(){n.makeCallMissed(u,d),t.clearData({type:u,chatid:l,id:d}),r.updateCallInvitationState(u,{chid:l,media_id:d},"missed")},6e4)),n.setCallStatus(l,d,u,"outgoing","ringing",p,"upstream"),n.setActiveCallData(l);var h={chid:l,media_id:d,cancelCbk:function(){n.makeCallCancel(u,d),r.updateCallInvitationState("audio",{chid:l,media_id:d},"cancelled"),t.clearData({type:u,chatid:l,id:d})},muteCbk:function(){return t.toggleMute()}};r.handleAudioCallInitiate(u,h),o.triggerIconCheck(l)},t.prototype.startApiDirectCall=function(e){var t=this,i=(e.conversationType,e.successCbk),n=this.container,a=n.uiHandler,o=n.MediaPermission,r=n.commonImpl,c=function(){clearTimeout(s)},s=setTimeout(function(){c=a.mediaPermissionUI()},3e3);return o.getAudioStream(function(){c(),t.directCallMediaPermissionSuccess(i)},function(){return t.directCallMediaPermissionFailure(function(){return c()})}),r.setActiveTab(),this.isDirectCallAllowed=!0},t.prototype.directCallMediaPermissionSuccess=function(e){var t=this;try{var i=this.container.detailsHandler;i.playNotifSound({tone:"outgoingcall",duration:60}),this.isDirectCallAllowed=!0;e(function(){return t.toggleMute()})}catch(e){}},t.prototype.directCallMediaPermissionFailure=function(e){var t=this.container.uiHandler;return e(),t.mediaPermissionUnlock(),t.directCallCancelled(),!1},t.prototype.handleUIApiReject=function(e,t,i){this.handleUIReject(e,t,i),this.container.detailsHandler.initMissedChat(chatid,"CALLENDED","2",!0)},t.prototype.handleUIApiCallEnd=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.detailsHandler;a.makeCallEnd(t,i,function(){return o.endSession(e)}),this.handleCallEnd({chatid:e,type:t,id:i}),localStorage.removeItem("siq_directcall")},t.prototype.onDirectCallStarted=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.detailsHandler,o=i.uiHandler,r=i.dataHandler,c=e.type,s=e.id,l=e.chatid,d=e.mediaRequest;n.setCredential(e);r.set(s+"_waiting_timer",setTimeout(function(){n.makeCallMissed(c,s),t.clearData({type:c,chatid:l,id:s}),a.initMissedChat(l,"CALLENDED","2",!0),o.updateCallInvitationState(c,{chid:l,media_id:s},"missed")},6e4)),n.setCallStatus(l,s,c,"outgoing","ringing",d,"upstream",!0),n.setActiveCallData(l);function u(){n.makeCallCancel(c,s,function(){return a.initMissedChat(l,"CALLENDED","2",!0)}),o.updateCallInvitationState("audio",{chid:l,media_id:s},"cancelled"),localStorage.removeItem("siq_directcall"),t.clearData({type:c,chatid:l,id:s})}function p(){return t.toggleMute()}a.triggerIconCheck(l);setTimeout(function(){return o.handleAudioCallInitiate(c,{chid:l,cancelCbk:u,muteCbk:p,media_id:s,isDirectCall:!0})},500),clearTimeout(a.getChatWinObjById(l).waitTimer),localStorage.setItem("siq_directcall",f({chid:l,media_id:s,type:c,status:"outgoing"}))},t.prototype.startAudioCallAgain=function(e){var t,i,n=this.container,a=n.detailsHandler,o=n.audioImpl;this.hasIncommingCall(e)||(i={type:"audio",chatid:(t=a.getChatWinObjById(e)).chatID,mode:"visitor",mediarequest:!0,mediainvitation:!0,wmsid:$Support.EmbedObj.vwmsid,lsuid:t.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid},o.startAudioCall(i))},t.prototype.pushVoiceToServer=function(e){var t={},i=$Support.getAjaxURL("makeav",dext),n=this.container.detailsHandler.getChatWinObjById(e);t.action="voicerec",t.wmsid=$Support.EmbedObj.vwmsid,t.chid=n.chatID,t.cuid=n.visitorID,t.lsuid=n.attender,$.ajax({url:i,data:t,type:"POST"})},t}(e),r=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.screenshareIconStatus=function(e){var t=e.chid,i=e.callback,n=e.type;void 0===n&&(n=1);var a=this.container.detailsHandler,o={not_group_chat:!a.isGroupConversation(t),not_bot:!a.isAttenderBot(t),ongoing_chat:a.isChatExist(),audiocall_enabled:a.isScreenShareAllowed(t),current_plan_allowed:a.isPlanAllowed()},r={sharescreenAllowed:!a.isShareScreenAllowed(t)},c={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed"]}[n].map(function(e){return o[e]}).reduce(function(e,t){return e&&t},!0),s={1:["sharescreenAllowed"]}[n].map(function(e){return r[e]}).reduce(function(e,t){return e&&t},!0);l(i)&&i(t,c?s?"disable":"show":"hide")},t.prototype.isScreenShareAllowed=function(e){var t=e.chatid,i=this.container,n=i.commonImpl,a=i.constants,o=i.detailsHandler,r=i.uiHandler,c=!0,s="",l="";return!n.getMediaDataByChidAndType({chatid:t,type:a.screen_share})&&(o.isSecureConnection()?o.isShareScreenAllowed(t)||(c=!1,l="siqMedia: screen share Failed screen share not allowed | chid - "+t):(c=!1,s=o.I18N("av.info.insecuredwebsite"),l="siqMedia: screen share Failed Visitor not in secure connection | chid - "+t),!c&&s&&(r.showDialog({desc:s,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),callBackAction(implConstants.postDebugLog,l)),c)},t}(i),c=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t}(t),s=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.checkAndUpdateUIForApi=function(){},t.prototype.playMediaNotificationSound=function(e){this.container.detailsHandler.playNotifSound(e)},t.prototype.stopNotificationSound=function(){this.container.detailsHandler.stopNotifSound()},t.prototype.showDesktopNotif=function(){},t.prototype.startApiCall=function(e){var t=e.conversationtype,i=this.container.constants[t]+"Impl";return this.container[i].startApiDirectCall(e)},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=t.constants,n=t.detailsHandler,a=t.commonImpl,o=n.isAudioCallEnabled(),r=(n.isScreenShareEnabled(),a.getCallStatusByChid(e)),c=new Array;o&&c.push(i.audio),c.push(i.screen_share),c.push(i.video);for(var s in r)!function(e){var t=r[e];c=c.filter(function(e){return![t.type].includes(e)})}(s);return c},t.prototype.checkAndPlayNotification=function(){},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=t.constants,n=t.detailsHandler,a=t.commonImpl,o=n.isAudioCallEnabled(),r=(n.isScreenShareEnabled(),a.getCallStatusByChid(e)),c=new Array;o&&c.push(i.audio),c.push(i.screen_share),c.push(i.video);for(var s in r)!function(e){var t=r[e];c=c.filter(function(e){return![t.type].includes(e)})}(s);return c},t.prototype.getFailureMessage=function(e){var t=null;switch(e.name){case"NotFoundError":case"DevicesNotFoundError":t=LSResource.getRealValue("av.info.microphone.notavailable");break;case"SourceUnavailableError":case"PermissionDeniedError":case"SecurityError":case"NotAllowedError":default:t=LSResource.getRealValue("av.info.microphone.blocked")}return t},t.prototype.sendMediaStats=function(e,t){var i=e.msg,n=((i?i.media:null)||e).id,a={};e.statcode&&(a.statcode=e.statcode),a.description=t;var o="stats/"+n+"/media";this.container.ajaxHandler.post(o,a,null,null)},t}(n);function C(e,t){for(var i=[],n=arguments.length-2;0<n--;)i[n]=arguments[n+2];return{tag:e,props:t||{},children:i}}function h(e,t){if(void 0===t&&(t={}),-1!=["number","string","undefined"].indexOf(typeof e))return document.createTextNode(e);var i=document.createElement(e.tag);p(i,e.props,t);for(var n=0;n<e.children.length;n++)i.appendChild(h(e.children[n],t));return i}function p(e,t,i){if(!e.skipattr)for(var n in t)"skipattr"==n?e.skipattr=!0:"on"==n.slice(0,2)?function(e,t,i){t=t.slice(2).toLowerCase(),e._listeners&&e._listeners[t]||e.addEventListener(t,function(e){return this._listeners[e.type](e)},!1);(e._listeners||(e._listeners={}))[t]=i}(e,n,t[n]):"ref"===n.slice(0,3)?i.refs[t[n]]=e:"html"===n.slice(0,4)?e.innerHTML=t[n]:"video"!=e.tagName.toLowerCase()||e[n]?n&&void 0!==t[n]&&$(e).attr(n)!=t[n]&&e.setAttribute(n,t[n]):e[n]=t[n]}Element.prototype.zsiqdrag=function(e,s){var l=0,d=0,u=this,p=!1;function h(e){var t=getComputedStyle(u),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;if(i<0||n<0)return i<0&&(u.style.left="0px"),n<0&&(u.style.top="0px"),p=!1,void(s?window.parent:window).removeEventListener("mousemove",h);var a=parseInt(t.getPropertyValue("right"))||0,o=parseInt(t.getPropertyValue("bottom"))||0;if(a<0||o<0){var r=e.pageX-l,c=e.pageY-d;return u.style.left=r-10+"px",u.style.top=c-10+"px",p=!1,void(s?window.parent:window).removeEventListener("mousemove",h)}u.style.left=e.pageX-l+"px",u.style.top=e.pageY-d+"px"}this.addEventListener("mousedown",function(e){p=!0;var t=getComputedStyle(u),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;l=e.pageX-i,d=e.pageY-n,(s?window.parent:window).addEventListener("mousemove",h)}),this.addEventListener("mouseup",function(e){!0===p&&(p=!1,(s?window.parent:window).removeEventListener("mousemove",h))})};function o(){this.embed=SiqAVRouter.container.detailsHandler.isEmbed(),this.reRender()}o.prototype.updateState=function(e){e&&(this.state=e);try{this.reRender()}catch(e){}},o.prototype.reRender=function(){var e;this.dom&&1==this.dom.nodeType?this.dom=function e(t,i,n,a){var o,r,c,s=t;if(t)if(o=t,(c=-1!=["string","number"].indexOf(typeof(r=i)))||3==o.nodeType?c&&3==o.nodeType&&o.textContent==r:o.tagName.toLowerCase()==r.tag.toLowerCase()){if("object"==typeof i&&1==t.nodeType){var l=Math.max(t.childNodes.length,i.children.length),d=Array.from(t.childNodes);p(t,i.props||{},a);for(var u=0;u<l;u++)e(d[u],i.children[u]?i.children[u]:"",t,a)}}else s=h(i,a),$(t).replaceWith(s);else i&&n.append(h(i,a));return s}(this.dom,this.render(),this.placeholder,this):(e=h(this.render(),this),this.dom&&$(this.dom).replaceWith(e),this.dom=e,this.embed?!this.disableDrag&&e.zsiqdrag&&e.zsiqdrag(e,this.frameout):this.disableDrag||1!=e.nodeType||$(e).draggable({containment:"window",scroll:!1})),this.dom&&!this.dom.parentNode&&(this.placeholder_prepend?$(this.placeholder).prepend(this.dom):$(this.placeholder).append(this.dom))},o.prototype.destroy=function(){$(this.dom).remove()};var d=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.screenShareAllowed=i.detailsHandler.isScreenShareAllowed(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.destroy=function(){this.ssTimer&&clearInterval(this.ssTimer),this.audioTimer&&clearInterval(this.audioTimer),$(this.dom).remove()},e.prototype.canStartSS=function(){return!this.state.screen_share},e.prototype.getUI=function(){var e=this.state,t=e.audio,i=e.screen_share;return!i||"sharing"!=i.type||t&&"connected"!=t.status?t&&(!i||"viewing"!=i.type||"viewing"==i.type&&"connected"!=t.status)?this.getAudioCallUI():"":this.getScreenShareUI()},e.prototype.getAudioCallBtns=function(){var e=this,t=this.state,i=t.handler,n=(t.name,t.url,t.screen_share),a=t.audio,o=t.chid,r=a.mute,c=a.status,s=this.container.detailsHandler,l="invited"==c,d="connected"==c,u="requested"==c,p="connecting"==c,h=s.isScreenShareAllowed()&&s.isShareScreenAllowed(o),m=n&&("connected"==n.status?"end":"cancel"),g="connected"==c?"end":"cancel";return C("div",{class:"cal_actns"},h&&!n&&d?C("div",{title:I("screenshare"),class:"sqico-screenshare",onclick:function(){return e.container.uiHandler.shareScreen(o)}}):"",n&&"sharing"==n.type?C("div",{title:I(m),class:"sqico-ssend",onclick:function(){return i(o,"screen_share","reject")}}):"",d||u||p?C("div",{title:I(r?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(r?"muteaudio":"microphone"),onClick:function(){return i(o,"audio","mute")}}):"",l?C("div",{title:I("accept"),class:"sqico-call",onclick:function(){return i(o,"audio","accept")}}):"",C("div",{title:I(g),class:"sqico-call reject-cal",ref:"audio_call_reject",onclick:function(){return i(o,"audio","reject")}}))},e.prototype.getScreenShareBtns=function(){var e=this.state,t=e.handler,i=e.screen_share,n=e.audio,a=e.chid,o=i&&("connected"==i.status?"end":"cancel"),r=n&&("connected"==n.status?"end":"cancel");return C("div",{class:"cal_actns"},C("div",{title:I(o),class:"sqico-ssend",onclick:function(){return t(a,"screen_share","reject")}}),n&&"connected"==n.status?C("div",{title:I(n.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(n.mute?"muteaudio":"microphone"),onClick:function(){return t(a,"audio","mute")}}):"",n&&"connected"==n.status?C("div",{title:I(r),class:"sqico-call reject-cal",ref:"audio_call_reject",onclick:function(){return t(a,"audio","reject")}}):"")},e.prototype.getAudioCallUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=(e.screen_share,e.audio),a=e.chid,o=(n.mute,n.status),r="invited"==o,c="requested"==o,s=i&&i(n.media_id)?C("img",{src:i(n.media_id,a),draggable:"false"}):C("em",{class:"sqico-person"});return C("div",{class:"zsembd_audiocl textC"},C("nav",{class:"zsembd_usrprof "+(r||c?"zsembd_calrng":"")},C("div",{class:" sqico-personimg"}," ",s," ")),C("span",{class:"zsembd_adodesc txtelips"},t(a),C("em",{class:"txtelips font14",ref:"audio_call_info"}," ",w(this.state)," ")),this.getAudioCallBtns())},e.prototype.getScreenShareUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=e.screen_share,a=(e.audio,e.chid),o=n.status,r=i&&i(n.media_id)?C("img",{src:i(n.media_id,a),draggable:"false"}):C("em",{class:"sqico-person"});return C("div",{class:"zsembd_audiocl textC"},C("nav",{class:"zsembd_usrprof "+("invited"==o?"zsembd_calrng":"")},C("div",{class:" sqico-personimg"}," ",r," ")),C("span",{class:"zsembd_adodesc txtelips"},t(a),C("em",{class:"txtelips font14",ref:"audio_call_info"}," ",A(this.state,!1)," ")),this.getScreenShareBtns())},e.prototype.render=function(){return this.state.isDirectCall||document.querySelector("#call_Busy")?"":this.getUI()},e}(o);function u(e,t,i){void 0===i&&(i=!0);var n={type:"audio",mode:"visitor",mediarequest:!0,mediainvitation:!0},a=e.detailsHandler.getChatWinObjById(t);i?$.extend(n,{chatid:a.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid}):$.extend(n,{chatid:t}),e.audioImpl.startAudioCall(n)}var m=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.init(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.init=function(){this.fullscreen=!1,this.showcntrl=!1,this.frameout=!0,this.switchCbk=this.switchFullscreen.bind(this)},e.prototype.switchFullscreen=function(){this.fullscreen=!this.fullscreen,this.fullscreen?window.addEventListener("keyup",this.switchCbk):window.removeEventListener("keyup",this.switchCbk),this.reRender()},e.prototype.getAudioCallBox=function(){var e=this.state,t=e.audio,i=e.handler,n=e.chid,a=e.name,o=e.url,r=this.embed?"siqico":"sqico",c=t&&("connected"==t.status?"end":"cancel");return C("div",{class:"zsiq_calldtl"},C("span",null,o&&o(t.media_id)?C("img",{src:o(t.media_id,n),class:"siquserimg"}):C("em",{class:r+"-user"}),C("em",{class:"zsiq_caller txtelips"},a(n))),C("span",null,w(this.state),t&&"connected"==t.status?C("em",{title:I(t.mute?"unmute":"mute"),class:r+"-"+(t.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return i(n,"audio","mute")},"data-type":"mic"}):"",t&&"invited"==t.status?C("em",{title:I("accept"),class:r+"-end zsiq_vend zsiq_ctrlico zsiq_callin",onclick:function(){return i(n,"audio","accept")}}):"",C("em",{title:I(c),class:r+"-end zsiq_vend zsiq_ctrlico",onclick:function(){return i(n,"audio","reject")}}),C("em",null)))},e.prototype.showCntrl=function(){var e=this;this.showcntrl=!0,clearTimeout(this.showCntrlTimer),this.showCntrlTimer=setTimeout(function(){e.showcntrl=!1,e.reRender()},1500),this.__swapHandlerClickCbk(),this.reRender()},e.prototype.__swapHandlerClickCbk=function(){this.swapOptions&&($(this.swapOptions).remove(),this.swapOptions=null)},e.prototype.__swapHandler=function(e,n,t){function a(){return o.__swapHandlerClickCbk.call(o)}function i(e,t,i){n(e,t,i),a()}var o=this;if(this.swapOptions)return a();this.swapOptions=h(C("div",{class:"zsiqcalloptions",id:"calloptions",style:"left:"+(e.clientX-220)+";top:"+(e.clientY-65)+";height:65px;z-index:11111111111;",onMouseLeave:this.__swapHandlerClickCbk.bind(this)},C("div",{onClick:function(){return i(t,"screen_share","swap")}},LSResource.getRealValue("screenshare.sharemyscreen")),C("div",{onClick:function(){return i(t,"screen_share","reject")}},LSResource.getRealValue("screenshare.endscreen")))),this.placeholder.append(this.swapOptions)},e.prototype._SwapList=function(e,t,i){this.embed&&this.state.audio&&!this.fullscreen?this.__swapHandler(e,t,i):t(i,"screen_share","swap")},e.prototype.__callCbk=function(){u(this.container,this.state.chid,this.embed)},e.prototype.getScreenShareButtons=function(){var t=this,e=this.state,i=e.screen_share,n=e.audio,a=e.handler,o=e.chid,r=e.chatWinFocused,c=i.status,s=this.embed?"siqico":"sqico",l=i&&("connected"==i.status?"end":"cancel"),d=n&&("connected"==n.status?"end":"cancel"),u=this.container.detailsHandler.isAudioCallEnabled();return C("div",{class:"zsiq_vctrl zsiq_center"},"connected"==c?C("em",{title:I("swap"),class:s+"-swap zsiq_ctrlico",onClick:function(e){return t._SwapList(e,a,o)}}):"",this.embed&&!this.fullscreen&&n&&"connected"==n.status?C("em",{title:I(n.mute?"unmute":"mute"),class:s+"-"+(n.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return a(o,"audio","mute")},"data-type":"mic"}):"",!this.embed&&!this.fullscreen&&r||this.state.audio||!u?"":C("em",{title:I("call"),class:s+"-call zsiqpickup zsiq_ctrlico",onclick:this.__callCbk.bind(this)}),this.embed&&!this.fullscreen&&n?C("em",{title:I(d),class:s+"-end zsiq_vend  zsiq_ctrlico",onclick:function(){return a(o,"audio","reject")}}):"",!this.fullscreen&&n&&this.embed?"":C("em",{title:I(l),class:s+"-ssend zsiq_vchat zsiq_ctrlico",onclick:function(){return a(o,"screen_share","reject")}}))},e.prototype.getUI=function(){var e=this.state,t=e.screen_share,i=e.audio,n=t.stream,a=t.timer,o=this.embed?"siqico":"sqico";return C("div",{class:"zsiq_video_main "+(this.fullscreen?"zsiq_maxvideo":"")+" "+(this.showcntrl||!a?"zsiq_showcntl":""),onMouseMove:this.showCntrl.bind(this),onMouseDown:this.__swapHandlerClickCbk.bind(this)},C("em",{class:o+"-maxicon zsiq_maxicon zsiq_center",onclick:this.switchFullscreen.bind(this)}),C("span",{class:"zsiq_vtime "+(a?"":"info"),id:"zsiqvideo_time"},A(this.state)),this.getScreenShareButtons(),C("video",{autoplay:!0,srcObject:n,className:"zsiq_video",id:"zsiqvideoviewer"}),this.fullscreen&&i?this.getAudioCallBox():"")},e.prototype.render=function(){var e=this.state.screen_share;return e&&"viewing"==e.type&&"requested"!=e.status?this.getUI():""},e}(o);function g(){var e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t={Chrome:"https://support.google.com/chrome/answer/2693767?hl=en",Firefox:"https://support.mozilla.org/en-US/questions/1168156",Opera:"https://help.opera.com/en/latest/web-preferences/#microphone",Safari:"https://support.apple.com/en-in/guide/safari/websites-ibrwe2159f50/mac"};t[e]&&window.open(t[e],"_blank")}function S(e,t,i,n,a){function o(){return $(s).remove()}function r(){var e=Recorder();a||(o(),$("body").append($Temp.getAudioRecordedUI(i(0,t),n(t)))),e.init(a,t)}var c,s;s=a?h(C("div",{class:"cal-wrap",id:"audiorec"},C("div",{class:"posrel dib-mid"},C("div",{class:"cal-widgt theme1 outcal"},C("div",{class:"posrel usr-imginfo"},C("div",{class:"cal-visimg "+((c=$Support.EmbedObj.clogo)?"":"sqico-user")},c?C("img",{src:c}):"")),C("div",{class:"cal-vstrdetl"},C("nav",{class:"cal-actvevstr elips font18"},LSResource.getRealValue("av.info.oprbusy")),C("p",{class:"cal-usrdesc elips"},LSResource.getRealValue("av.info.voicemsg"))),C("div",{class:"cal-optns posrel textR"},C("span",{onclick:r,class:"sqico-record bg-aaa"})))))):h(C("div",{class:"zsembd_audiocl textC",id:"call_Busy"},C("em",{class:"sqico-close",onClick:o}),C("nav",{class:"zsembd_usrprof"},C("div",{class:"'+perscls+' sqico-personimg"},C("div",{class:"cal-visimg "},C("img",{src:i&&i(0,t)})))),C("span",{class:"zsembd_adodesc txtelips"},n(t),C("em",{class:"txtelips font14"},LSResource.getRealValue("av.info.userbusy"))),C("div",{class:"cal_actns"},C("div",{class:"call-record",title:LSResource.getRealValue("av.info.voicemessage"),onclick:r}),C("div",{class:"sqico-call",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return o()&&u(e,t)}})))),a?(CallImpl.isCallWithChat=!0,$("body").prepend(s)):(s.zsiqdrag(),$("body").append(s))}var _=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.disableDrag=!0,this.placeholder_prepend=!0,n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.getAudioCallStatusText=function(){var e=this.state.audio,t=e.status,i=e.timer;return{timer:i,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting"),initiated:LSResource.getRealValue("audiovideo.ringing"),mediapermission:LSResource.getRealValue("av.info.waitingformediapermission")}[i?"timer":t]||""},e.prototype.getUI=function(){var e=this.state,t=e.url,i=e.handler,n=e.name,a=e.chid,o=e.audio,r=o&&o.status,c=-1==["initiated","requested"].indexOf(r)&&t&&t(o.media_id,a)||$Support.EmbedObj.clogo,s="initiated"==r,l="mediapermission"==r;return C("div",{class:"cal-wrap",id:"audiocal"},C("div",{class:"posrel dib-mid"},C("div",{class:"cal-widgt theme1 outcal"},C("div",{class:"posrel usr-imginfo"},C("div",{class:"cal-visimg "},C("img",{src:c}))),C("div",{class:"cal-vstrdetl"},C("nav",{class:"cal-actvevstr elips font18"},n&&n(a)||""),C("p",{class:"cal-usrdesc elips"},this.getAudioCallStatusText())),C("div",{class:"cal-optns posrel textR"},C("span",{title:o&&I(o.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(o.mute?"muteaudio":"microphone")+" bg-aaa "+(l?"cmn_disable":""),onclick:function(){return l?"":i(a,"audio","mute")}}),C("span",{class:"sqico-call cal-rjct "+(s||l?"cmn_disable":""),id:"audiocall_outgoingend",onclick:function(){return s||l?"":i(a,"audio","reject")}})))))},e.prototype.render=function(){var e=this.state,t=e.isDirectCall,i=e.audio;e.status;return t&&i?this.getUI():""},e}(o);function I(e){var t={mute:LSResource.getRealValue("av.info.mute"),unmute:LSResource.getRealValue("av.info.unmute"),end:LSResource.getRealValue("common.end"),reject:LSResource.getRealValue("common.reject"),screenshare:LSResource.getRealValue("common.screenshare"),swap:LSResource.getRealValue("av.info.swap"),call:LSResource.getRealValue("av.info.call"),cancel:LSResource.getRealValue("common.cancel"),accept:LSResource.getRealValue("common.accept")};return t[e]?t[e]:""}function b(e,t){return"theme4"!=k()?"":C("div",{class:"thme-bgimg",style:"background-image:url("+("Comp"==e?$Support.EmbedObj.clogo:_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+t.attenderimagefkey+"/photo.ls?nps=404")+")"})}function k(){return window.parent.$ZSIQWidget.getWidgetObject().calltheme||"theme1"}function w(e,t){void 0===t&&(t=!0);var i=e.audio,n=i.status,a=i.timer;return{timer:a,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[a&&t?"timer":n]||""}function A(e,t){void 0===t&&(t=!0);var i=e.screen_share,n=i.status,a=i.timer;return{timer:a,connected:LSResource.getRealValue(t?"common.connected":"ss.info.viewing"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[a&&t?"timer":n]||""}function R(e){return SiqAVRouter.container.detailsHandler.getChatWinObjById(e)}function D(e,t){void 0===e&&(e=0);var i=R(t).attenderimagefkey,n=_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+i+"/photo.ls?mid="+e;return i?n:$Support.EmbedObj.clogo}function q(e){return H[e]||""}function T(e){var t=this;this.container=e,this.invitations=null,this.ss_invitation={},this.states={},window.onbeforeunload=function(){var e=localStorage.getItem("siq_directcall");if((e=e&&JSON.parse(e))&&(e.is_refreshed=!0,localStorage.setItem("siq_directcall",JSON.stringify(e))),Object.keys(t.states).length)return""}}var H={};function M(){return SiqAVRouter.container.detailsHandler.isEmbed()?$(parent.document.body):$("body")}T.prototype.initiateHeadshot=function(e,t){this.states[e]||(this.states[e]={chid:e,isDirectCall:t},this.states[e].headshot=new d(this.states[e],$("body"),this.container),this.states[e].directCallUI=new _(this.states[e],$("body"),this.container))},T.prototype.updateCallInvitationState=function(e,t,i){var n={audio:{connecting:this.makeAudioCallConnecting,connected:this.makeAudioCallConnected,ended:this.makeAudioCallEnded,cancelled:this.makeAudioCallCancelled,rejected:this.makeAudioCallRejected,missed:this.makeAudioCallMissed,reconnecting:this.makeAudioReconnecting},screen_share:{connecting:this.makeScreenShareConnecting,connected:this.makeScreenShareConnected,ended:this.makeScreenShareEnded,cancelled:this.makeScreenShareCancelled,rejected:this.makeScreenShareRejected,missed:this.makeScreenShareMissed,reconnecting:this.makeScreenShareReconnecting}},a=n[e]&&n[e][i];try{a&&a.call(this,e,t)}catch(e){}},T.prototype.playScreenShareStream=function(e){var t=e.stream,i=(e.mid,e.endCbk,e.chid);this.initiateHeadshot(i);var n=this.states[i];n.screen_share=n.screen_share||{},$.extend(!0,n,{screen_share:{stream:t}});try{n.player||(n.player=new m(n,M(),this.container))}catch(e){}},T.prototype.handleAudioCallInvite=function(e,t){H[t.chid]=R(t.chid).attendername,"audio"==e?(this.showAudioCallInvitation(t),this.invitations=!0):"screen_share"==e&&this.showScreenShareInvitation(t),$(".zsembd_audiocl .sqico-close").click()},T.prototype.clearAudioCallInvite=function(e){var t=this.states[e];t&&t.audio&&delete t.audio,t&&t.screen_share&&delete t.screen_share,this.ss_invitation[e]&&$(this.ss_invitation[e]).remove(),this.__updateState(e),t&&this.__checkAndDestroyInstance(e)},T.prototype.showAudioCallInvitation=function(e){var t=e.chid,i=e.rejectCbk,n=e.acceptCbk,a=e.media_id;this.initiateHeadshot(t);var o=this.states[t];$.extend(!0,o,{handler:this.handleActionHandler.bind(this),name:q,url:D,chid:t,audio:{mute:!1,media_id:a,reject_cbk:i,accept_cbk:n,is_invited:!0,status:"invited"}}),this.__updateState(t),$Support.getParent().$ZSIQChatWindow.openChatWindow()},T.prototype.handleAudioCallInitiate=function(e,t){var i=this,n=t.chid,a=t.cancelCbk,o=t.muteCbk,r=t.media_id,c=t.isDirectCall;c?(this.states[n]=this.states.directcall,delete this.states.directcall):this.initiateHeadshot(n,c),H[n]=R(n).attendername;var s=this.states[n];$(".zsembd_audiocl .sqico-close").click(),$.extend(!0,s,{handler:this.handleActionHandler.bind(this),name:q,url:D,chid:n,audio:{mute:!!c&&s.audio.mute,media_id:r,reject_cbk:a,mute_cbk:function(){o(),$.extend(!0,s,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},is_invited:!1,status:"requested"}}),this.__updateState(n)},T.prototype.initiateDirectCallUI=function(e){var t=this;void 0===e&&(e=null);function i(){e(),$.extend(!0,o,{audio:{mute:!t.states[n].audio.mute}}),t.__updateState(n)}var n="directcall";if(e){var a=this.states[n];return $.extend(!0,a,{audio:{mute:!1,mute_cbk:i,status:"initiated"}}),void this.__updateState(n)}$("#audiorec,#audiocal").remove(),this.initiateHeadshot(n,!0);var o=this.states[n];$.extend(!0,o,{audio:{mute:!1,mute_cbk:i,status:"mediapermission"}}),this.__updateState(n)},T.prototype.makeAudioCallConnecting=function(e,t){var i=this,n=t.chid,a=t.muteCbk,o=t.rejectCbk,r=(t.media_id,t.name,t.isDirectCall),c=this.states[n];EmbedSound.stop(),H[t.chid]=R(t.chid).attendername,$.extend(!0,c,{isDirectCall:r,audio:{mute_cbk:function(){a(),$.extend(!0,c,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},reject_cbk:o,status:"connecting"}}),this.__updateState(n),r&&this.stopSoundNotification()},T.prototype.makeAudioCallConnected=function(e,t){t.media_id;var i=t.chid,n=t.callEndCbk,a=t.isDirectCall;EmbedSound.stop(),this.initiateHeadshot(i),this.ss_invitation[i]&&delete this.ss_invitation[i];var o=this.states[i];$.extend(!0,o,{isDirectCall:a,audio:{reject_cbk:n,status:"connected",connected_time:(new Date).getTime()}}),setTimeout(this.startTimer.bind(this,i,e),500),this.__updateState(i)},T.prototype.makeAudioReconnecting=function(e,t){this.__makeReconnecting(e,t)},T.prototype.makeAudioCallEnded=function(e,t){this.__callTerminate(e,t,"ended")},T.prototype.makeAudioCallCancelled=function(e,t){this.__callTerminate(e,t,"cancelled")},T.prototype.makeAudioCallRejected=function(e,t){this.states[t.chid].isDirectCall&&this.container.detailsHandler.initMissedChat(t.chid,"CALLENDED","2",!0),this.__callTerminate(e,t,"rejected")},T.prototype.makeAudioCallMissed=function(e,t){this.__callTerminate(e,t,"missed")},T.prototype.__recordSound=function(e,t){var i=this,n=this.container.detailsHandler.isChatExist(e);(1==this.container.detailsHandler.getSupportRepCount(e)&&n||t)&&($("#audiorec").remove(),S(this.container,e,D,q,t),this.__updateState(e),$(".zsembd_audiocl .sqico-close").on("click",function(){return i.__updateState(e)}))},T.prototype.__callTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,t.isDirectCall),r=this.states[a],c=r.audio.is_invited;EmbedSound.stop(),r&&r.audio?(this.stopTimer(a,e),this.invitations=c?null:this.invitations,$.extend(!0,r,{audio:{status:i}}),setTimeout(function(){var e=r.isDirectCall;delete r.audio,n.__updateState(a),n.__checkAndDestroyInstance(a),c||-1==["rejected","missed"].indexOf(i)||n.__recordSound(a,e),e&&"ended"==i&&n.implementRatingUI(a),e&&"cancelled"==i&&n.directCallCancelled()},500),this.__updateState(a),o&&(this.stopSoundNotification(),clearTimeout(this.container.detailsHandler.getChatWinObjById(a).waitTimer))):r&&this.__checkAndDestroyInstance(a)},T.prototype.__checkAndDestroyInstance=function(e){try{var t=Object.keys(this.states[e]);0==["audio","screen_share"].filter(function(e){return-1!=t.indexOf(e)}).length&&delete this.states[e]}catch(e){}},T.prototype.showScreenShareInvitation=function(e){var t,i=e.chid,n=e.rejectCbk,a=e.acceptCbk,o=e.media_id;this.initiateHeadshot(i);function r(){$(t).remove(),a()}function c(e){void 0===e&&(e=!0),$(t).remove(),e&&n()}var s,l,d,u,p;l=(s={name:q,acceptHandler:r,rejectHandler:c,chid:i}).name,d=s.acceptHandler,u=s.rejectHandler,p=s.chid,t=h(C("div",{class:"zsiq_popup",id:"zsiqssconfirmbox"},C("div",{class:"zsiq_popupsub"},C("em",{class:"siqico-close zsiq_center",onClick:u}),C("em",{class:"siqico-screenshare zsiq_popuplogo"}),C("div",{class:"zsiq_popup_hdr"},LSResource.getRealValue("common.screenshare")),C("div",{class:"zsiq_popup_desc"},LSResource.getRealValue("screenshare.request.desc",l(p))),C("div",{class:"zsiq_popup_btn zsiq_center"},C("span",{class:"zsiq_center",id:"zsiqconfirmss",onClick:d},LSResource.getRealValue("common.share")),C("span",{class:"zsiq_center zsiq_cancelbtn",id:"zsiqdecliness",onClick:u},LSResource.getRealValue("common.decline")))))),$(M()).append(t),this.ss_invitation[i]={rejectHandler:c,acceptHandler:r,media_id:o,template:t}},T.prototype.showScreenShareMaking=function(e,t){var i=t.chid,n=t.cancelCbk,a=t.media_id;this.initiateHeadshot(i);var o=this.states[i],r=0==this.container.screenShareImpl.getScreenShareType(i,a)?"sharing":"viewing";$.extend(!0,o,{handler:this.handleActionHandler.bind(this),name:q,url:D,chid:i,screen_share:{media_id:a,reject_cbk:n,status:"requested",type:r}}),this.__updateState(i)},T.prototype.makeScreenShareConnecting=function(e,t){var i=t.chid,n=t.muteCbk,a=t.rejectCbk,o=t.media_id;t.name;this.initiateHeadshot(i);var r=this.states[i],c=0==this.container.screenShareImpl.getScreenShareType(i,o)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:q,url:D,chid:i,screen_share:{media_id:o,mute_cbk:n,reject_cbk:a,status:"connecting",type:c}}),this.__updateState(i)},T.prototype.makeScreenShareConnected=function(e,t){var i=this,n=t.media_id,a=t.chid,o=t.callEndCbk;this.initiateHeadshot(a);var r=this.states[a],c=0==this.container.screenShareImpl.getScreenShareType(a,n)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:q,url:D,screen_share:{reject_cbk:o,status:"connected",connected_time:(new Date).getTime(),type:c,swap_cbk:function(){return i.__swapScreen(n,a)}}}),setTimeout(this.startTimer.bind(this,a,e),500),this.__updateState(a)},T.prototype.makeScreenShareReconnecting=function(e,t){this.__makeReconnecting(e,t)},T.prototype.makeScreenShareEnded=function(e,t){this.__ssTerminate(e,t,"ended")},T.prototype.makeScreenShareCancelled=function(e,t){this.__ssTerminate(e,t,"cancelled")},T.prototype.makeScreenShareRejected=function(e,t){this.__ssTerminate(e,t,"rejected")},T.prototype.makeScreenShareMissed=function(e,t){this.__ssTerminate(e,t,"missed")},T.prototype.__ssTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,this.states[a]);this.ss_invitation[a]&&(this.ss_invitation[a].rejectHandler(!1),delete this.ss_invitation[a]),o&&o.screen_share?(this.stopTimer(a,e),$.extend(!0,o,{screen_share:{status:i}}),setTimeout(function(){delete o.screen_share,n.__updateState(a),n.__checkAndDestroyInstance(a),o.player&&delete o.player},500),this.__updateState(a)):o&&this.__checkAndDestroyInstance(a)},T.prototype.showDialog=function(){},T.prototype.enableOutingCallUI=function(){},T.prototype.handleActionHandler=function(e,t,i){var n=this.states[e]&&this.states[e][t]&&this.states[e][t][i+"_cbk"];n&&n.call(this)},T.prototype.getTimeDiff=function(e){var t=(new Date).getTime()-e,i=(i=Math.floor(t%36e5/6e4))<10?"0"+i:i,n=(n=Math.floor(t%6e4/1e3))<10?"0"+n:n;return isFinite(i)&&isFinite(n)?i+":"+n:""},T.prototype.startTimer=function(t,i){var n=this;this.states[t][i].timer_ref||(this.states[t][i].timer_ref=setInterval(function(){var e=n.states[t];$.extend(!0,e[i],{timer:n.getTimeDiff(e[i].connected_time)}),n.__updateState(e.chid)},1e3))},T.prototype.stopTimer=function(e,t){var i=this.states[e];clearInterval(i[t].timer_ref),delete i[t].timer,this.__updateState(i.chid)},T.prototype.playSoundNotification=function(e,t){void 0===e&&(e="incomingcall"),void 0===t&&(t="audiocall");var i={type:t,duration:this.container.constants.WAITING_TIME_SECS,tone:e};this.container.detailsHandler.playNotifSound(i)},T.prototype.stopSoundNotification=function(){this.container.detailsHandler.stopNotifSound()},T.prototype.__updateState=function(e){var t=this.states[e];t&&([t.headshot,t.player,t.directCallUI].forEach(function(e){e&&e.updateState()}),this.handleMinimizeState())},T.prototype.__swapScreen=function(e,t){var i=this,n=this.container.detailsHandler.getEncryChid(t),a=R(t),o=h(C("div",{class:"zsiq_video_alert"},C("div",{class:"zsiq_valert_cnt"},LSResource.getRealValue("screenshare.swap.sharing")),C("div",{class:"zsiq_btnmain"},C("span",{class:"zsiq_valert_btn",onClick:function(){i.container.screenShareImpl.swapScreenShare({chatid:t,id:e},{chatid:n,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid}),$(o).remove()}},LSResource.getRealValue("common.continue")),C("span",{class:"zsiq_valert_btn zsiq_redbtn",onClick:function(){return $(o).remove()}},LSResource.getRealValue("common.cancel")))));$(M()).append(o)},T.prototype.__makeReconnecting=function(e,t){var i=t.chid,n=(t.media_id,this.states[i]);this.stopTimer(i,e),n[e].status="reconnecting",this.__updateState(i)},T.prototype.shareScreen=function(e){var t=R(e);this.container.screenShareImpl.startScreenShare({chatid:t.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:t.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid})},T.prototype.mediaPermissionUI=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=h(C("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},C("div",{class:"zsiq-cal-hnt-cont "+("Chrome"==e?"":"zsiq-"+e)},C("div",{class:"zsiq-trtp-anim"}),C("span",{class:"siqico-arrow zsiq-arrow"}),C("span",{class:"zsiq-alw-mic siqico-mic"}),C("div",{class:"zsiq-alw-mic-desc",html:LSResource.getRealValue("av.info.pleaseallowmicrophone")})))));return $(M()).append(i),function(){return $(i).remove()}},T.prototype.mediaPermissionUnlock=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=h(C("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},C("div",{class:"zsiq-cal-hnt-cont zsiq-isblk "+("Chrome"==e?"":"zsiq-"+e)},C("div",{class:"zsiq-trtp-anim "}),C("span",{class:"siqico-arrow zsiq-arrow"}),C("div",{html:LSResource.getRealValue("av.info.pleasetaponlock","<em class='siqico-lock'></em>")}),C("p",null,"(",LSResource.getRealValue("common.or"),")"),C("div",null,LSResource.getRealValue("av.info.enablemicrophonesetting")),C("div",{class:"calndr-sedulbtn",style:"",onclick:g}," ",LSResource.getRealValue("chatwindow.mailcopy.clickhere")," ")))));return $(M()).append(i),$UI.showBanner(LSResource.getRealValue("av.info.microphone.blocked"),!0,null,15e3),function(){return $(i).remove()}},T.prototype.handleCallClash=function(e){e()},T.prototype.handleMinimizeState=function(){var e=this.invitations,t=this.container.commonImpl.getActiveCallData();e||t?($Support.getParent().$ZSIQWidgetUI.updateCallUI(),e?$Support.getParent().$ZSIQWidgetUI.updateIncomingCallUI():$Support.getParent().$ZSIQWidgetUI.removeIncomingCallUI()):$Support.getParent().$ZSIQWidgetUI.removeCallUI()},T.prototype.forceEndCall=function(){for(var e in this.states)this.container.commonImpl.endCallByChid(e),this.container.detailsHandler.triggerIconCheck(e)},T.prototype.implementRatingUI=function(e){var t,i,n=(i=e,h(C("div",{class:"cal-wrap",id:"audiocal"},C("div",{class:"posrel dib-mid"},C("div",{class:"cal-widgt theme1 outcal"},C("div",{class:"posrel usr-imginfo"},C("div",{class:"cal-visimg "},C("img",{src:(t=D)&&t(0,i)}))),C("div",{class:"cal-vstrdetl textC"},C("nav",{class:"cal-actvevstr elips font16"},LSResource.getRealValue("av.info.rating")),C("div",{class:"rating font18"},C("span",{class:"reaction_ico sad_icon","data-reaction":"sad",documentclick:"sendCallRating",title:LSResource.getRealValue("common.sad")}),C("span",{class:"reaction_ico neutral_icon","data-reaction":"neutral",documentclick:"sendCallRating",title:LSResource.getRealValue("common.neutral")}),C("span",{class:"reaction_ico happy_icon","data-reaction":"happy",documentclick:"sendCallRating",title:LSResource.getRealValue("common.happy")})),C("p",{class:"c777 font14"},LSResource.getRealValue("ne.rating.byline"))))))));CallImpl.isCallWithChat=this.container.detailsHandler.getEncryChid(e),SiqAVRouter.chatwinobj=this.container.detailsHandler.getChatWinObjById(e),this.container.detailsHandler.getChatWinObjById(e).hideMaskDiv(),JSON.parse($Support.EmbedObj.eprops.reaction[0])?($("#audiorec,#audiocal").remove(),$("body").prepend(n)):this.implementRatingFdbkUI(SiqAVRouter.chatwinobj)},T.prototype.implementRatingFdbkUI=function(e){var t,i,n,a,o,r=(t=e,i=D,n=q,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,o=$Support.isSignature($Support.EmbedObj),h(C("div",{class:"cal-wrap",id:"audiocal"},C("div",{class:"adocal-cont dtfix "+k()+" cal-oflne",style:"height:354px;"},b(null,t),C("div",{class:"header"},o?"":C("div",{class:"actbtn"},C("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),C("div",{class:"posrel dib-mid"},C("div",{class:"cal-visimg sqico-user"},C("img",{src:i&&i(0,a)})),t.rating?C("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng"}):""),C("div",null,C("div",{class:"cal-cmpname font20 fontB"},n(a)))),C("div",{class:"cal-bodycont posrel"},t.rating?C("div",{class:"ofln-msg mT5"}," ",$Support.getReactionIndex(t.rating)," "):""),C("div",{class:"cal-footer",style:"height:70px;"},C("textarea",{class:"bg-f6 font13 c333 lH20",dockeyup:"feedback",dockeydown:"textarea",id:"fdbkarea","data-validate":"required",placeholder:LSResource.getRealValue("av.info.fdkbckmsg"),autofocus:"",style:"overflow: hidden;"}),C("div",{class:"sqico-calsend fdbak-send msg-send",documentclick:"sendCallFb",title:LSResource.getRealValue("embed.submit")}))))));JSON.parse($Support.EmbedObj.eprops.feedback[0])?($($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handlefbCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(r)):this.directCallCancelled()},T.prototype.implementFdbkSuccessUI=function(e){var t,i,n,a,o,r=(t=e,i=D,n=q,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,o=$Support.isSignature($Support.EmbedObj),h(C("div",{class:"cal-wrap",id:"audiocal"},C("div",{class:"adocal-cont dtfix "+k()+" cal-oflne"},b(null,t),C("div",{class:"header"},o?"":C("div",{class:"actbtn"},C("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),C("div",{class:"posrel dib-mid"},C("div",{class:"cal-visimg sqico-user"},C("img",{src:i&&i(0,a)})),t.rating?C("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng",title:t.rating}):""),C("div",null,C("div",{class:"cal-cmpname font20 fontB"},n(a)))),C("div",{class:"cal-bodycont posrel"},C("div",{class:"ofln-msg mT5"},LSResource.getRealValue(t.rating?"av.info.ratingandfbk":"faq.feedback")),C("div",{class:"sqico-call bg-grn mT25 mA",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return parent.$zohosq.call.start()}}))))));$Support.getParent().$ZSIQWidgetUI.handleMinCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(r)},T.prototype.directCallCancelled=function(){$("#audiorec,#audiocal").remove(),$("body").prepend(CallUIHandler.getCallCancelledHtml()),$Support.isSignature($Support.EmbedObj)&&$("div.actbtn").remove(),$($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handleMinCall()};function j(e){this.container=e}j.prototype.post=function(e,t,i,n){this.request("POST",e,t,i,n)},j.prototype.get=function(e,t,i){this.request("GET",url,e,t,i)},j.prototype.request=function(e,t,i,n,a){var o=_SCHEMA+"://"+_EMBEDSERVERURL+"/visitor/v2/"+_SCREENNAME+"/"+t;try{$.ajax({url:o,type:e,data:i,success:n||function(){},error:a||function(){}})}catch(e){}};function E(e){this.container=e,this.uiutil=$Support,this.isembed=!0}E.prototype.handleEndSession=function(e,t){this.onGoingCallForChat(e)?this.container.commonImpl.endCallByChid(e,t):t()},E.prototype.onGoingCallForChat=function(e){return!!this.container.commonImpl.getCallStatusByChid(e)},E.prototype.getEncryChid=function(e){return $Support.chidmappinglist[e]},E.prototype.isEmbed=function(){return this.isembed},E.prototype.getChatWinObjById=function(e,t){void 0===t&&(t=!1);var i=t?e:this.getEncryChid(e);return ZSIQConversationManager.getChatWinObjById(i)},E.prototype.getSupportReps=function(e,t){void 0===t&&(t=!1);var i=t?e:this.getEncryChid(e);return SUPPORT_REPS[i]||null},E.prototype.getSupportRepCount=function(e,t){void 0===t&&(t=!1);var i=this.getSupportReps(e,t);return i&&Object.keys(i).length},E.prototype.isGroupConversation=function(e,t){void 0===t&&(t=!1);try{return 1<this.getSupportRepCount(e,t)}catch(e){return!1}},E.prototype.isAttenderBot=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).isBotChat},E.prototype.isChatExist=function(e,t){void 0===t&&(t=!1);var i=this.getChatWinObjById(e,t);return"connected"==i.chatstatus&&!i.isBotChat},E.prototype.getAttenderId=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).attender},E.prototype.isProactiveChat=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).proactive},E.prototype.getCurrentUserId=function(){return null},E.prototype.playNotifSound=function(e){var t=e.tone,i=e.duration,n=e.chatid,a=e.isEncrypted,o=!n||this.getChatWinObjById(n,a);n&&o.isSoundOff()||EmbedSound.play(t,i)},E.prototype.stopNotifSound=function(){EmbedSound.stop()},E.prototype.initMissedChat=function(e,t,i,n){var a=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();delete $Support.requestRunning_missedvisitor,this.uiutil.handleMissed(t,i,n,a),this.uiutil.removeWtimeCookie(a.chatID),delete a.reopenwaiting,$Support.removeBroadCast()},E.prototype.clearPlayer=function(){this.getBody().find(".zsiq_video_main").remove()},E.prototype.getBody=function(){return $(parent.document.body)},E.prototype.triggerAudioCallIcon=function(e,t){var i=$("#audiocall");"show"==t?(this.showAudioCall(),i.removeClass("cmn_disable").show(),i.show().parent().addClass("rgt_ico")):"hide"==t?(this.hideAudioCall(),i.hide().parent().removeClass("rgt_ico")):"disable"==t&&(this.showAudioCall(),i.addClass("cmn_disable"))},E.prototype.triggerScreenShareIcon=function(){},E.prototype.showAudioCall=function(){$("#audiocall").show(),$(".callagain-txt").show()},E.prototype.hideAudioCall=function(){$("#audiocall").hide(),$(".callagain-txt").hide(),$("#call_Busy").remove()},E.prototype.isAudioCallEnabled=function(){var e="true"==$Support.getParent().$ZSIQChat.getWidgetData().embedobj.isaudiocallallowed,t="true"==$Support.EmbedObj.eprops.isaudiocall;return e&&t},E.prototype.isPlanAllowed=function(){return Licence.verify("audiocall")},E.prototype.isScreenShareAllowed=function(){return CommonUtil.isScreenshareEnabledFromPortal()&&$Support.EmbedObj.eprops.issiqscreenshare&&Licence.verify("issiqscreenshare")},E.prototype.hasIncomingCall=function(e){var t=this.container.commonImpl.getCallStatusByChid(e);for(var i in t){var n=t[i];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1},E.prototype.isActiveBySSType=function(e){var t={isActive:!1,id:null},i=this.container.commonImpl.getActiveCallData();if(!i)return t;if(i==e){var n=this.container.commonImpl.getCallStatusByChid(i);for(var a in n){var o=n[a].type,r=n[a].id;if("screen_share"==o)return t.isActive=!0,t.id=r,t}}return t},E.prototype.isShareScreenAllowed=function(e){if(!this.container.commonImpl.currentUserBrowserSupportSS())return!1;var t=this.isActiveBySSType(e),i=t.isActive,n=t.id;return 0!=this.container.screen_shareImpl.getScreenShareType(e,n)||!i},E.prototype.checkIsSSOnGoing=function(e,t){var i=this.container.commonImpl.getActiveCallData();return!!i&&(i!=e||("share_screen"==t?this.isShareScreenAllowed(e):"view_screen"==t?this.isRequestScreenShareAllowed(e):void 0))},E.prototype.checkActiveScreenShare=function(e,t){var i=this.container.commonImpl.getCallStatusByChid(e);for(var n in i){var a=i[n],o=a.id;if("screen_share"==a.type){var r=this.container.screenShareImpl.getScreenShareType(e,o);if(1==r)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0;if(0==r)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0}}return!1},E.prototype.isSecureConnection=function(){return-1<window.location.protocol.indexOf("https")},E.prototype.isAudioRecordingSupported=function(){return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.URL=window.URL||window.webkitURL,navigator.getUserMedia=this.container.MediaPermission.getUserMediaDetail(),window.AudioContext&&navigator.getUserMedia&&window.URL&&window.Worker||(support=!1),!0},E.prototype.closeViewMediaPermission=function(){$(window.parent.document).find("body").find(".zsiq_prv_main").remove()},E.prototype.isliveChatWindow=function(){return"msgarea"==$Support.container.attr("cwview")},E.prototype.isFaceBookIntegration=function(){return-1<window.location.href.lastIndexOf("facebook.ext")},E.prototype.getVisitorWMSID=function(){return this.uiutil.EmbedObj.vwmsid},E.prototype.getLsid=function(){return $Support.getParent().$ZSIQWidget.getWidgetObject().lsid},E.prototype.getVisitorID=function(){},E.prototype.getVisitorBrowser=function(){},E.prototype.getVisitorUserAgent=function(){},E.prototype.getVisitorPage=function(){},E.prototype.getUTSDetail=function(){},E.prototype.isMobileVisitor=function(){},E.prototype.isIOSSDKVisitor=function(){},E.prototype.isChatMonitor=function(){return!1},E.prototype.getCurretUserLSUID=function(){},E.prototype.I18N=function(){},E.prototype.getChatAttender=function(){},E.prototype.isVisitorOnline=function(){},E.prototype.isOngoingChat=function(){return!1},E.prototype.checkBrowserSupported=function(){},E.prototype.getBrowserFromUserAgent=function(){},E.prototype.addVisitorDetail=function(){},E.prototype.pickupsupport=function(){},E.prototype.endSession=function(e){var t=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();$Support.quitChat(t)},E.prototype.getChatIdByVisitorId=function(){},E.prototype.isScreenShareEnabled=function(){},E.prototype.sendDebugLogger=function(){},E.prototype.hideAudioCallIcon=function(){},E.prototype.showAudioCallIcon=function(){},E.prototype.disableCallAgainOption=function(){},E.prototype.showCallAgainOption=function(){},E.prototype.removeAudioCallIcon=function(){},E.prototype.isCallIconEnabled=function(){},E.prototype.initVideoPlayer=function(){},E.prototype.isAllowedForCurrTab=function(){},E.prototype.getRepresentative=function(){},E.prototype.isVisitorBrowserSupported=function(){},E.prototype.isVisitorOSSupported=function(){},E.prototype.getVisitorOS=function(){},E.prototype.audioIconStatus=function(){},E.prototype.screenshareIconStatus=function(){},E.prototype.triggerIconCheck=function(e){this.container.audioImpl.audioIconStatus(e,this.triggerAudioCallIcon.bind(this))},E.prototype.focusChatWindow=function(){},E.prototype.joinChat=function(){},E.prototype.canShowAudioCallInvitation=function(){return!0},E.prototype.endCall=function(e,t){this.container.commonImpl.endCallByChid(e,t)},E.prototype.isAudioCallDisabled=function(){return!1},E.prototype.toJSON=function(e){return JSON.stringify(e)},E.prototype.handleCallInitiate=function(){},E.prototype.handleCallEnded=function(){},E.prototype.handleCallCancelled=function(){},E.prototype.handleCallRejected=function(){},E.prototype.handleCallMissed=function(){};function U(e){this.container=e,this.init(e)}U.prototype.handle=function(e){this.route(e.param)},U.prototype.route=function(e){var t,i,n=e.msg.media,a=n.type,o=n.chatid,r=n.id,c=e.msg,s=c.operation;c.cbtype;this.checkIsCurrentTab(o)||-1!=["call_initiate","call_cancel","call_miss"].indexOf(s)?l(i=(t=this.getController(a))&&t[this.getHandler(e)])&&(i.call(t,e.msg.media),this.container.commonImpl.sendMediaStats(e,null)):(this.container.uiHandler.clearAudioCallInvite(a,r),this.container[a+"Impl"].clearData(e.msg.media),Sound.stop())},U.prototype.init=function(e){this.audio_impl=e.audioImpl,this.video_impl=e.videoImpl,this.screen_share_impl=e.screenShareImpl,this.common_impl=e.commonImpl},U.prototype.getController=function(e){return this[e+"_impl"]},U.prototype.getHandler=function(e){var t=e.msg,i=t.cbtype,n=t.status,a=t.operation,o=this.getStatus(n),r=this.getOperations(a),c=this.getCBTypes(i);return o||r||c},U.prototype.getOperations=function(e){return{call_credential:"setCredential",call_initiate:"handleInvitation",call_accept:"handleCallAccept",call_reject:"handleCallReject",call_candidates:"handleCandidates",call_answer:"handleCallAnswer",call_end:"handleCallEnd",call_offer:"handleCallOffer",call_cancel:"handleCallCancel",call_miss:"handleCallMissed",call_invite:"handleCallInvite"}[e]},U.prototype.getCBTypes=function(){return{credential:"setCredential",invite:"handleInvitation",reject:"handleCallReject",candidate:"handleCandidates",answer:"handleCallAnswer",offer:"handleCallOffer",cancel:"handleCallCancel",miss:"handleCallMissed",invite:"handleCallInvite"}},U.prototype.getStatus=function(e){return{accept:"handleCallAccept",end:"handleCallEnd"}[e]},U.prototype.checkIsCurrentTab=function(){return Boolean(this.container.commonImpl.getActiveTab())};function O(){this.container=this.container}O.prototype.getEventsMap=function(){return{mute:"",end_media:"",sharescreen:"",shareaudio:"",stop_audio:"",stop_screenshare:""}};function L(e){this.container=e,this.init(e)}L.prototype.handle=function(){},L.prototype.init=function(){};function B(e){this.conatiner=e}B.prototype.handle=function(){};function V(e){((this.container=e).MediaPermission=this).isSupported=void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia,this.displayMediaSupported=this.isSupported&&navigator.mediaDevices.getDisplayMedia&&void 0!==navigator.mediaDevices.getDisplayMedia,this.init(),this.getmediaDevices(this.updateMediaDevices.bind(this),null)}V.prototype.init=function(){this.type={audio:"audio",video:"video",audio_video:"audio_video",screen:"screen_share"},this.streamType={audio:1,video:2,screen:3,audio_video:4},this.streamTypeInString={1:"audio",2:"video",3:"screen_share",4:"audio_video"},this.devicesType={audioInput:"audioinput",videoInput:"videoinput",audioOutput:"audiooutput"}},V.prototype.isDisplayMediaSupported=function(){return this.displayMediaSupported},V.prototype.updateMediaDevices=function(e){this.devicesArray=e;var t=[],i=[];for(var n in this.devicesArray){var a=this.devicesArray[n];a.kind==this.devicesType.audioInput?t.push(a):a.kind==this.devicesType.videoInput&&i.push(a)}this.availableDevices={audioInput:t,videoInput:i}},V.prototype.getAvailableDevices=function(){return this.availableDevices},V.prototype.getmediaDevices=function(t){void 0!==navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices().then(function(e){return t(e)})},V.prototype.updatePreferredDevice=function(e){this.preferredDevice||(this.preferredDevice={}),this.preferredDevice[e.type]=e},V.prototype.getPreferredDevice=function(e){return this.preferredDevice?this.preferredDevice[e]:null},V.prototype.getAudioInputDevices=function(){return this.availableDevices.audioInput},V.prototype.getVideoInputDevices=function(){return this.availableDevices.videoInput},V.prototype.getMediaConstraints=function(e,t){var i={},n=!0,a=!0,o=this.getPreferredDevice(this.devicesType.audioInput),r=this.getPreferredDevice(this.devicesType.videoInput);return o&&(n={deviceId:{exact:o.deviceId}}),r&&(a={deviceId:{exact:r.deviceId}}),i=Object.assign({},{audio:n,video:a},t),e==this.type.audio?i.video=!1:e!=this.type.video&&e!=this.type.screen||(i.audio=!1),i},V.prototype.requestStream=function(i,n,t,e,a,o){var r,c,s=this,l=null;this.streams?l=this.streams[i]:this.streams=[],l?n():(r=a?navigator.mediaDevices.getDisplayMedia:navigator.mediaDevices.getUserMedia,c=this.getMediaConstraints(i,e),r.call(navigator.mediaDevices,c).then(function(e){var t;s.setType(e,i),s.streams[i]=e,"function"!=typeof o||(t=e._getPrimaryVideoTrack())&&(t.onended=o),n()}).catch(function(e){t(e,i)}))},V.prototype.getAudioStream=function(e,t,i,n){this.requestStream(this.type.audio,e,t,i,!1,n)},V.prototype.getVideoStream=function(e,t,i,n){this.requestStream(this.type.video,e,t,i,!1,n)},V.prototype.getScreenShareStream=function(e,t,i,n){var a;this.displayMediaSupported?this.requestStream(this.type.screen,e,t,i,!0,n):(a={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId}}},this.requestStream(this.type.screen,e,t,a,!1,n))},V.prototype.getStreamByType=function(e){return this.streams?this.streams[e]:null},V.prototype.getScreenSharePermissionWithAudio=function(){},V.prototype.getAudioPermission=function(e,t){this.getPermission(this.type.audio,e,t)},V.prototype.getVideoPermission=function(e,t){this.getPermission(this.type.video,e,t)},V.prototype.getPermission=function(e,t,i){navigator.permissions.query({name:e}).then(function(e){"function"==typeof t&&t(e.state)}).catch(function(e){"function"==typeof i&&i(e)})},V.prototype.setType=function(e,t){var i="";return e.salesiq||(i=e.salesiq={}),i._type=t,i},V.prototype.getTypeFromStream=function(e){return e&&e.salesiq&&e.salesiq._type?e.salesiq._type:null},V.prototype.closeAllStream=function(){for(var e in this.streams)this.closeStream(e)},V.prototype.closeStreamByType=function(e){this.closeStream(e)},V.prototype.closeStream=function(e){var t=this.streams?this.streams[e]:null;if(t){var i=t.getTracks();for(var n in i)i[n].stop();this.streams[e]=null}},V.prototype.toggleMute=function(){var e=this.streams[this.type.audio];e.getAudioTracks()[0].enabled=!e.getAudioTracks()[0].enabled},V.prototype.screenEndFromBrowserUI=function(e){this.streams[this.type.screen].getVideoTracks()[0].onended=function(){e()}},V.prototype.getUserMediaDetail=function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null};function P(e){this.container=e,this.userAgent=navigator.userAgent,this.browserName=null,this.browserVersion=null,this.browserSupported=!1,(e.MediaDetails=this).platform=navigator.platform,this.setBrowserName()}P.prototype.setBrowserName=function(){var e,t,i,n,a,o=(e=this.userAgent,i="unknown-unknown",-1<(a=(n=e).toLowerCase()).indexOf("msie")?i=(t=n.substring(n.indexOf("MSIE")).split(";")[0]).split(" ")[0].replace("MSIE","IE")+"-"+t.split(" ")[1]:-1<a.indexOf("edge")?i=n.substring(n.indexOf("Edge")).split(" ")[0].replace("/","-"):-1<a.indexOf("safari")&&-1<a.indexOf("version")?i=n.substring(n.indexOf("Safari")).split(" ")[0].split("/")[0]+"-"+n.substring(n.indexOf("Version")).split(" ")[0].split("/")[1]:-1<a.indexOf("opr")||-1<a.indexOf("opera")?-1<a.indexOf("opera")?i=n.substring(n.indexOf("Opera")).split(" ")[0].split("/")[0]+"-"+n.substring(n.indexOf("Version")).split(" ")[0].split("/")[1]:-1<a.indexOf("opr")&&(i=n.substring(n.indexOf("OPR")).split(" ")[0].replace("/","-").replace("OPR","Opera")):-1<a.indexOf("chrome")?i=n.substring(n.indexOf("Chrome")).split(" ")[0].replace("/","-"):-1<a.indexOf("firefox")&&(i=n.substring(n.indexOf("Firefox")).split(" ")[0].replace("/","-")),[i,parseInt(i.split("-")[1])]);this.browserName=o[0],this.browserVersion=o[1]},P.prototype.getBrowserName=function(){return this.browserName},P.prototype.getBrowserVersion=function(){return this.browserVersion},P.prototype.checkBrowserSupported=function(){var e=this.browserName.split("-")[0];return this.browserSupported=!1,"Chrome"==e?this.browserSupported=23<=this.browserVersion:"Firefox"==e?this.browserSupported=22<=this.browserVersion:"Opera"==e?this.browserSupported=18<=this.browserVersion:"Safari"==e&&(this.browserSupported=11<=this.browserVersion),this.browserSupported},P.prototype.getPlatform=function(){return this.platform};function x(e){this.data={},this.container=e,this.unique="SiqMedia_",e.dataHandler=this}x.prototype.get=function(e){this.getLocalKey(e);return this.data[e]},x.prototype.set=function(e,t){this.getLocalKey(e);this.data[e]=t},x.prototype.remove=function(e){this.getLocalKey(e);this.data[e]&&delete this.data[e]},x.prototype.getLocalKey=function(e){return this.unique+e};function z(e){(e.router=this).container=e,this.init(e)}var N={WAITING_TIME:6e4,WAITING_TIME_SECS:60,audio:"audio",video:"video",screen_share:"screen_share",0:"audio",2:"video",1:"screen_share",connecting:"connecting",facebookUrl:"https://facebook.com/pages"};z.prototype.init=function(e){this.rtc_router=new U(e),this.event_router=new O,this.media_router=new L(e),this.action_router=new B(e),this.MediaPermission=new V(e),this.dataHandler=new x(e),this.MediaDetails=new P(e),this.container.constants=N},z.prototype.route=function(e){if(!this.validateRouteObject(e))throw"Media Router Schema Mismatch";this.handle(e)},z.prototype.handle=function(e){try{var t=this[e.type+"_router"];t&&t.handle&&t.handle(e)}catch(e){}},z.prototype.validateRouteObject=function(t){var i={type:"string",module:"string",useCase:"string",param:"object"},n=!0;return Object.keys(i).forEach(function(e){t[e]&&typeof t[e]==i[e]||(n=!1)}),n};function F(e){(e.LSRouter=this).container=e,this.init()}F.prototype.init=function(){var e=this,t=this;this.container;this.routes={0:function(){return e.container.checkDirectCallOnload()},2:t.handleCustomMessage(),29:t.handleAVcall.bind(t),13:t.handleUserStatus.bind(t),113:t.chatEnded.bind(t),35:t.chatEnded.bind(this),114:t.checkForCallIcon.bind(this),14:t.checkForCallIcon.bind(this),15:t.checkForCallIcon.bind(this)}},F.prototype.chatEnded=function(e){var t=e.msg.chid;$("#call_Busy").remove(),this.container.uiHandler.clearAudioCallInvite(t),this.container.detailsHandler.triggerIconCheck(t),this.container.detailsHandler.hideAudioCall()},F.prototype.handleMessage=function(e){var t,i,n=this.routes,a=typeof n[e.mtype];try{"function"==a?n[e.mtype].call(this,e):"object"==a&&(t=this.getModuleName(e),"function"==typeof(i=n[e.mtype][t])&&i.call(this,e))}catch(e){}},F.prototype.handleCustomMessage=function(){var e=this;return{addvisitor:e.showInvitation,acctranschat:e.endCall,closetransfer:e.checkForCallIcon,pickupsupport:e.handlePicksupport,leavesupport:e.endSupport,missedvisitor:e.missedDirectCall,joinsupport:e.joinsupport}},F.prototype.handlePicksupport=function(e){var t=e.msg,i=LSMessanger.getPrd()+"_"+$Support.getParent().$ZSIQWidget.getEmbedObject().pinfo.soid+"_"+t.attender;try{for(var n in SUPPORT_REPS[t.chid])n!=i&&delete SUPPORT_REPS[t.chid][n]}catch(e){}this.checkForCallIcon(e)},F.prototype.handlePresenceMessage=function(){return{}},F.prototype.handleLsOperations=function(e){var t={}[e.msg.msg.mode||JSON.parse(e.msg.msg).mode];"function"==typeof t&&t(e.msg)},F.prototype.handleAVcall=function(e){e.msg.msg=JSON.parse(e.msg.msg),e.msg.msg.media=JSON.parse(e.msg.msg.media),this.container.router.route({type:"rtc",module:e.msg.msg.media.type,useCase:e.msg.msg.cbtype||e.msg.msg.operation,param:e.msg})},F.prototype.getModuleName=function(t){return{2:"msg > module",114:"msg > msg > mode",700:"msg > msg > module"}[t.mtype].trim().split(/\s*\>\s*/g).forEach(function(e){return t=t[e]}),t},F.prototype.showInvitation=function(e){try{var t=e.msg,i=t.media;if(!i)return;var n="";for(var a in i)n=JSON.parse(i[a]).type;this.container[n+"Impl"].handleApiCallInvitation(t)}catch(e){}},F.prototype.missedDirectCall=function(e){var t=e.msg,i=t.media;if(i){for(var n in i){var a=JSON.parse(i[n]),o=a.type,r={chatid:this.container.detailsHandler.getChatIdByVisitorId(t.visitorid),id:a.id,type:o};this.container[o+"Impl"].handleCallCancel(r)}}},F.prototype.checkForCallIcon=function(e){var t=this.container,i=e.msg,n=i.chatid||i.chid;t.detailsHandler.triggerIconCheck(n),t.detailsHandler.isGroupConversation(n)&&$("#call_Busy").remove()},F.prototype.endSupport=function(e){var t=e.msg,i=t.chatid||t.chid;this.container.detailsHandler.removeAudioCallIcon(i),this.endCall(e)},F.prototype.disableAvIcons=function(){},F.prototype.endCall=function(e){try{var t=this.container,i=e.msg,n=i.chatid||i.chid;t.commonImpl.endCallByChid(n),this.checkForCallIcon(e)}catch(e){}},F.prototype.handleUserStatus=function(e){this.checkForCallIcon(e)},F.prototype.joinsupport=function(e){this.checkForCallIcon(e),this.container.commonImpl.checkOnGoingCall()},$(document).ready(function(){var e,o={},t=$Support.getParent();(e=o).commonImpl=new s(e),e.audioImpl=new a(e),e.videoImpl=new c(e),e.screen_shareImpl=new r(e),o.uiHandler=new T(o),o.ajaxHandler=new j(o),o.detailsHandler=new E(o),o.logger=LSDebugger.postDebugInfo,o.lsrouter=new F(o),window.SiqAVRouter=new z(o),window.avUIhandler=o.uiHandler,o.commonImpl.checkOnGoingCall(),o.checkDirectCallOnload=function(){var e,t,i,n,a=localStorage.getItem("siq_directcall");(a=a&&JSON.parse(a))&&(e=a.chid,t=a.media_id,i=a.type,"outgoing"==(n=a.status)?($Support.audioid=t,o.commonImpl.makeCallMissed(i,t),o.detailsHandler.initMissedChat(e,"CALLENDED","2",!0)):"connected"==n&&(o.audioImpl.endOngoingCall(e,t),o.detailsHandler.endSession(e)),localStorage.removeItem("siq_directcall"))},!$Support.isChatExist()&&t.$zohosq.values.initiatecall&&t.$zohosq.call.start()})}();
